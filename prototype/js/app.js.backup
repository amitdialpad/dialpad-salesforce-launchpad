// Main App Logic - Handles navigation and page rendering

// Helper function to get correct asset path for GitHub Pages vs Local
function getAssetPath(path) {
    const basePath = window.BASE_PATH || '/';
    return basePath + path;
}

const App = {
    currentPage: 'home',

    async init() {
        // Initialize data service
        await DataService.init();

        // Initialize role manager
        RoleManager.init();

        // Update tab visibility based on role
        this.updateTabVisibility();

        // Initialize app state
        AppState.init();

        // Attach navigation listeners
        this.attachNavigationListeners();

        // Attach demo control listeners
        this.attachDemoControlListeners();

        // Listen for role changes
        window.addEventListener('roleChanged', () => {
            this.updateTabVisibility();
            this.renderCurrentPage();
        });

        // Listen for app state changes
        window.addEventListener('appStateChanged', (e) => {
            this.handleStateChange(e.detail);
        });

        // Listen for hash changes for navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#/')) {
                const page = hash.substring(2); // Remove '#/'
                this.renderPage(page);
            }
        });

        // Start auto-refresh
        this.startAutoRefresh();

        // Render initial page
        this.renderPage('home');

        // Show onboarding if first time user
        if (AppState.isFirstTimeUser && !AppState.hasSeenOnboarding) {
            setTimeout(() => this.showOnboardingModal(), 1000);
        }
    },

    startAutoRefresh() {
        setInterval(() => {
            // Only auto-refresh on home page
            if (this.currentPage === 'home') {
                this.simulateDataUpdate();
                this.refreshHomePageData();
            }
        }, 30000); // Refresh every 30 seconds
    },

    refreshHomePageData() {
        // Refresh only the data content without re-rendering banners or showing loading state
        const content = document.getElementById('main-content');
        const role = RoleManager.getRole();

        // Directly update the content without loading state
        content.innerHTML = this.renderHomePage(role);
        this.renderHomeCharts(role);
    },

    simulateDataUpdate() {
        // Randomly update some metrics to simulate real-time changes
        const users = DataService.users;

        // Randomly change 1-2 agent states
        const agents = users.filter(u => u.role === 'Agent');
        const states = ['On Call', 'Available', 'Wrap-Up', 'Break'];

        if (agents.length > 0) {
            const randomAgent = agents[Math.floor(Math.random() * agents.length)];
            randomAgent.state = states[Math.floor(Math.random() * states.length)];
        }

        // Slightly increase call counts
        users.forEach(user => {
            if (Math.random() > 0.7) { // 30% chance
                user.callsToday += 1;
            }
        });
    },

    attachNavigationListeners() {
        const tabs = document.querySelectorAll('[data-page]');
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.currentTarget.getAttribute('data-page');
                this.renderPage(page);
            });
        });
    },

    renderPage(page) {
        this.currentPage = page;

        // Update URL hash to match the page
        if (window.location.hash !== `#/${page}`) {
            window.history.pushState(null, '', `#/${page}`);
        }

        // Update active tab in context bar
        document.querySelectorAll('.slds-context-bar__item[data-page], .slds-context-bar__item a[data-page]').forEach(item => {
            const contextBarItem = item.hasAttribute('data-page') ? item.parentElement : item;
            if (contextBarItem && contextBarItem.classList.contains('slds-context-bar__item')) {
                contextBarItem.classList.remove('slds-is-active');
            }
        });
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
            const activeTab = activeLink.closest('.slds-context-bar__item');
            if (activeTab) {
                activeTab.classList.add('slds-is-active');
            }
        }

        // Show loading state
        const content = document.getElementById('main-content');
        content.innerHTML = this.renderLoadingState();

        // Simulate loading delay for realistic feel
        setTimeout(() => {
            const role = RoleManager.getRole();

            switch(page) {
                case 'home':
                    content.innerHTML = this.renderHomePage(role);
                    this.renderHomeCharts(role);
                    // Attach listeners for banners and notifications
                    this.attachBannerListeners();
                    this.attachNotificationListeners();
                    this.attachHomePageListeners(role);
                    break;
                case 'calls':
                    content.innerHTML = this.renderCallsPage(role);
                    setTimeout(() => {
                        this.attachBannerListeners();
                        this.attachCallsPageListeners();
                    }, 0);
                    break;
                case 'sms':
                    content.innerHTML = this.renderSmsPage(role);
                    setTimeout(() => {
                        this.attachBannerListeners();
                        this.attachSmsPageListeners();
                    }, 0);
                    break;
                case 'powerdialer':
                    content.innerHTML = this.renderPowerdialerPage(role);
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'reports':
                    content.innerHTML = this.renderReportsPage(role);
                    setTimeout(() => {
                        this.attachBannerListeners();
                        this.attachReportsPageListeners();
                    }, 0);
                    break;
                case 'settings':
                    content.innerHTML = this.renderSettingsPage(role);
                    setTimeout(() => {
                        this.attachBannerListeners();
                        this.attachSettingsPageListeners();
                    }, 0);
                    break;
                case 'voicemail':
                    content.innerHTML = this.renderComingSoonPage('Voicemail', 'View and manage your voicemail messages with transcription and playback.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'recordings':
                    content.innerHTML = this.renderComingSoonPage('Recordings', 'Access and search all call recordings with filters and sharing options.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'contacts':
                    content.innerHTML = this.renderComingSoonPage('Contacts', 'Standard Salesforce Contacts view with click-to-dial integration.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'accounts':
                    content.innerHTML = this.renderComingSoonPage('Accounts', 'Standard Salesforce Accounts view with communication history.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'leads':
                    content.innerHTML = this.renderComingSoonPage('Leads', 'Standard Salesforce Leads view with call tracking and conversion.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'opportunities':
                    content.innerHTML = this.renderComingSoonPage('Opportunities', 'Standard Salesforce Opportunities view with call insights.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'analytics':
                    content.innerHTML = this.renderComingSoonPage('Analytics', 'Advanced analytics with AI-powered insights, predictions, and trends.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                case 'team':
                    content.innerHTML = this.renderComingSoonPage('Team', 'Manage team members, assign quotas, and view real-time agent status.');
                    setTimeout(() => this.attachBannerListeners(), 0);
                    break;
                default:
                    content.innerHTML = '<p>Page not found</p>';
            }

            // Re-attach notification listeners after page render
            setTimeout(() => this.attachNotificationListeners(), 0);
        }, 300);
    },

    // Generate banners HTML for inclusion in dashboard pages
    getAlertBannersHTML() {
        let bannersHTML = '';

        // Integration disconnected banner (Admin only - critical)
        if (AppState.integrationStatus === 'disconnected' && RoleManager.getRole() === 'admin') {
            bannersHTML += `
                <div class="slds-scoped-notification slds-media slds-media_center slds-theme_error" role="alert" style="margin-bottom: 0.5rem;">
                    <div class="slds-media__figure">
                        <span class="slds-icon_container slds-icon-utility-error" title="error">
                            <svg class="slds-icon slds-icon_small" aria-hidden="true" style="fill: #c23934;">
                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#error")}"></use>
                            </svg>
                        </span>
                    </div>
                    <div class="slds-media__body">
                        <p>
                            <strong>Salesforce Integration Disconnected</strong>
                            <span class="slds-m-left_xx-small">
                                Call logging and data sync are currently disabled. Reconnect to resume normal operations.
                            </span>
                            <a href="#" id="go-to-integration-health" class="slds-m-left_small" style="color: #001642; text-decoration: underline;">View Integration Health</a>
                        </p>
                    </div>
                </div>
            `;
        }

        // Package update banner with sandbox testing recommendation (Admin only)
        if (AppState.showVersionBanner && AppState.needsUpdate() && RoleManager.getRole() === 'admin') {
            const showSandboxWarning = AppState.showSandboxWarning && AppState.environment === 'production' && !AppState.hasTestedInSandbox;

            bannersHTML += `
                <div class="slds-scoped-notification slds-media slds-media_center ${showSandboxWarning ? 'slds-theme_warning' : 'slds-scoped-notification_light'}" role="alert">
                    <div class="slds-media__figure">
                        <span class="slds-icon_container slds-icon-utility-info" title="information">
                            <svg class="slds-icon slds-icon-text-default slds-icon_small" aria-hidden="true">
                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#info")}"></use>
                            </svg>
                        </span>
                    </div>
                    <div class="slds-media__body">
                        <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                            <div class="slds-col">
                                <p>
                                    <strong>New Version Available: ${AppState.latestVersion}</strong>
                                    <span class="slds-m-left_xx-small">
                                        You're currently on version ${AppState.currentVersion}.
                                    </span>
                                    ${showSandboxWarning ? '<span class="slds-m-left_xx-small">We strongly recommend testing in a Sandbox environment first - <a href="#" id="sandbox-guide-link">Learn more</a></span>' : ''}
                                </p>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <a href="#" id="view-changelog-link" class="slds-m-right_small">
                                    View what's new
                                </a>
                                <a href="#" id="update-package-link">
                                    Update now
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="slds-media__figure slds-media__figure_reverse">
                        <button class="slds-button slds-button_icon slds-button_icon-border" id="close-version-banner" title="Dismiss">
                            <span class="slds-icon_container">
                                <span aria-hidden="true">✕</span>
                            </span>
                            <span class="slds-assistive-text">Dismiss</span>
                        </button>
                    </div>
                </div>
            `;
        }

        return bannersHTML;
    },

    // Attach event listeners for banner actions
    attachBannerListeners() {
        // Attach banner event listeners
        setTimeout(() => {
            const integrationHealthLink = document.getElementById('go-to-integration-health');
            if (integrationHealthLink) {
                integrationHealthLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.navigateAdminSection('integration');
                });
            }

            const changelogLink = document.getElementById('view-changelog-link');
            if (changelogLink) {
                changelogLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showChangelogModal();
                });
            }

            const updateLink = document.getElementById('update-package-link');
            if (updateLink) {
                updateLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('In a real implementation, this would redirect to Salesforce AppExchange or package installation page.');
                });
            }

            const closeVersionBtn = document.getElementById('close-version-banner');
            if (closeVersionBtn) {
                closeVersionBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    AppState.setVersionBanner(false);
                    AppState.showSandboxWarning = false;
                    // Page will auto-refresh due to state change event
                });
            }

            const sandboxGuideLink = document.getElementById('sandbox-guide-link');
            if (sandboxGuideLink) {
                sandboxGuideLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('Sandbox Testing Guide:\n\n1. Create a Sandbox copy of your Production org\n2. Install the latest package version in Sandbox\n3. Test all features thoroughly\n4. Once verified, install in Production\n\nThis prevents any issues from affecting your live environment.');
                });
            }
        }, 0);
    },

    // Generate notifications widget HTML for inclusion in dashboard pages
    getNotificationsWidgetHTML() {
        const notifications = AppState.getNotifications();
        const count = notifications.length;

        if (count === 0) {
            return '';
        }

        let notificationsHTML = `
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                <span>Notifications</span>
                                <span class="slds-badge slds-m-left_x-small">${count}</span>
                            </h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body">
        `;

        notifications.forEach(notification => {
            let iconColor = '#0176d3';
            let textColorClass = 'slds-text-color_default';
            if (notification.type === 'error') {
                iconColor = '#c23934';
                textColorClass = 'slds-text-color_error';
            }
            if (notification.type === 'warning') {
                iconColor = '#fe9339';
                textColorClass = 'slds-text-color_error';
            }

            let callListHTML = '';
            if (notification.showCallList) {
                const unloggedCalls = DataService.getUnloggedCalls(notification.callCount);
                callListHTML = `
                    <div class="slds-box slds-box_x-small slds-theme_shade slds-m-vertical_x-small">
                        ${unloggedCalls.map((call, index) => `
                            <div class="slds-p-vertical_x-small ${index < unloggedCalls.length - 1 ? 'slds-border_bottom' : ''}">
                                <div class="slds-grid slds-grid_vertical-align-start">
                                    <div class="slds-col slds-has-flexi-truncate">
                                        <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">${call.contact}</p>
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            ${call.userName} - ${DataService.formatTimestamp(call.timestamp)}
                                        </p>
                                    </div>
                                    <div class="slds-col slds-no-flex slds-text-align_right">
                                        <p class="slds-text-body_small slds-text-title ${textColorClass} slds-m-bottom_xxx-small">${DataService.formatDuration(call.duration)}</p>
                                        <p class="slds-text-body_small slds-text-color_weak">${call.direction}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            notificationsHTML += `
                <div class="slds-media slds-m-around_small slds-p-around_small ${notification !== notifications[notifications.length - 1] ? 'slds-border_bottom' : ''}">
                    <div class="slds-media__figure">
                        <span class="slds-icon_container" style="background-color: ${iconColor};">
                            <svg class="slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">
                                <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${notification.icon}`)}"></use>
                            </svg>
                        </span>
                    </div>
                    <div class="slds-media__body">
                        <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">${notification.title}</p>
                        <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">${notification.message}</p>
                        ${callListHTML}
                        <button class="slds-button slds-button_neutral slds-button_stretch slds-m-top_x-small" data-notification-action="${notification.action}">
                            ${notification.actionLabel}
                        </button>
                    </div>
                </div>
            `;
        });

        notificationsHTML += `
                </div>
            </div>
        `;

        return notificationsHTML;
    },

    // Attach event listeners for notification actions
    attachNotificationListeners() {
        setTimeout(() => {
            document.querySelectorAll('[data-notification-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.getAttribute('data-notification-action');
                    this.handleNotificationAction(action);
                });
            });
        }, 0);
    },

    renderNotifications() {
        const notifications = AppState.getNotifications();
        const notificationsList = document.getElementById('notifications-list');

        if (!notificationsList) return;

        if (notifications.length === 0) {
            notificationsList.innerHTML = `
                <li class="slds-dropdown__item" role="presentation">
                    <div class="slds-text-align_center slds-p-around_medium">
                        <p class="slds-text-body_small slds-text-color_weak">No notifications</p>
                    </div>
                </li>
            `;
            return;
        }

        notificationsList.innerHTML = notifications.map(notification => {
            let iconColor = '#0176d3';
            let textColorClass = 'slds-text-color_default';
            if (notification.type === 'error') {
                iconColor = '#c23934';
                textColorClass = 'slds-text-color_error';
            }
            if (notification.type === 'warning') {
                iconColor = '#fe9339';
                textColorClass = 'slds-text-color_error';
            }

            // If this is unlogged calls notification, show the call list
            let callListHTML = '';
            if (notification.showCallList) {
                const unloggedCalls = DataService.getUnloggedCalls(notification.callCount);
                callListHTML = `
                    <div class="slds-box slds-box_x-small slds-theme_shade slds-m-vertical_x-small">
                        ${unloggedCalls.map((call, index) => `
                            <div class="slds-p-vertical_x-small ${index < unloggedCalls.length - 1 ? 'slds-border_bottom' : ''}">
                                <div class="slds-grid slds-grid_vertical-align-start">
                                    <div class="slds-col slds-has-flexi-truncate">
                                        <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">${call.contact}</p>
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            ${call.userName} • ${DataService.formatTimestamp(call.timestamp)}
                                        </p>
                                    </div>
                                    <div class="slds-col slds-no-flex slds-text-align_right">
                                        <p class="slds-text-body_small slds-text-title ${textColorClass} slds-m-bottom_xxx-small">${DataService.formatDuration(call.duration)}</p>
                                        <p class="slds-text-body_small slds-text-color_weak">${call.direction}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <li class="slds-dropdown__item" role="presentation">
                    <div class="slds-media slds-media_center slds-p-around_small slds-border_bottom">
                        <div class="slds-media__figure">
                            <span class="slds-icon_container" style="background-color: ${iconColor};">
                                <svg class="slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">
                                    <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${notification.icon}`)}"></use>
                                </svg>
                            </span>
                        </div>
                        <div class="slds-media__body">
                            <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">${notification.title}</p>
                            <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">${notification.message}</p>
                            ${callListHTML}
                            <button class="slds-button slds-button_neutral slds-button_stretch" data-notification-action="${notification.action}">
                                ${notification.actionLabel}
                            </button>
                        </div>
                    </div>
                </li>
            `;
        }).join('');

        // Attach action listeners
        setTimeout(() => {
            document.querySelectorAll('[data-notification-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.getAttribute('data-notification-action');
                    this.handleNotificationAction(action);
                });
            });
        }, 0);
    },

    handleNotificationAction(action) {
        const dropdown = document.getElementById('notifications-dropdown');

        // Close dropdown
        if (dropdown) {
            dropdown.classList.add('slds-hide');
        }

        switch(action) {
            case 'view-changelog':
                this.showChangelogModal();
                break;
            case 'reconnect':
                alert('This would open the integration settings to reconnect the Dialpad integration to Salesforce.');
                break;
            case 'view-settings':
                this.renderPage('settings');
                break;
            case 'review-calls':
                alert('This would show a list of unlogged calls to review and log manually.');
                break;
        }
    },

    renderLoadingState() {
        return `
            <div class="loading-container">
                <div role="status" class="slds-spinner slds-spinner_medium slds-spinner_brand">
                    <span class="slds-assistive-text">Loading...</span>
                    <div class="slds-spinner__dot-a"></div>
                    <div class="slds-spinner__dot-b"></div>
                </div>
                <p class="slds-text-align_center slds-m-top_medium">Loading...</p>
            </div>
        `;
    },

    renderCurrentPage() {
        this.renderPage(this.currentPage);
    },

    renderHomePage(role) {
        if (role === 'admin') {
            return this.renderAdminDashboard();
        } else if (role === 'supervisor') {
            return this.renderSupervisorDashboard();
        } else {
            return this.renderAgentDashboard();
        }
    },

    renderDateRangePicker() {
        const currentRange = AppState.dateRange;
        const label = AppState.getDateRangeLabel();

        return `
            <div class="slds-m-bottom_medium">
                <div class="slds-grid slds-gutters">
                    <div class="slds-col">
                        <div class="slds-form-element">
                            <label class="slds-form-element__label" for="date-range-select">
                                <span class="slds-text-title_caps slds-p-bottom_x-small">Date Range</span>
                            </label>
                            <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <select class="slds-select" id="date-range-select">
                                        <option value="today" ${currentRange === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="this-week" ${currentRange === 'this-week' ? 'selected' : ''}>This Week</option>
                                        <option value="this-month" ${currentRange === 'this-month' ? 'selected' : ''}>This Month</option>
                                        <option value="last-30-days" ${currentRange === 'last-30-days' ? 'selected' : ''}>Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminDashboard() {
        const metrics = DataService.getAdminMetrics();

        return `
            ${this.getAlertBannersHTML()}

            <!-- Single-Page Admin Launchpad -->
            <div style="max-width: 1600px; margin: 0 auto;">
                ${this.renderAdminLaunchpad(metrics)}
            </div>
        `;
    },


    renderAdminLaunchpad(metrics) {
        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="Admin Dashboard">Admin Dashboard</h1>
                                <p class="slds-page-header__meta-text">Company-wide system overview</p>
                            </div>
                        </div>
                    </div>
                    <div class="slds-page-header__col-actions">
                        <div class="slds-page-header__controls">
                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" title="Refresh">
                                <svg class="slds-button__icon" aria-hidden="true">
                                    <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#refresh")}"></use>
                                </svg>
                                <span class="slds-assistive-text">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="slds-page-header__row slds-m-top_small">
                    <div class="slds-grid slds-grid_vertical-align-center" style="gap: 1rem;">
                        <!-- Date Range Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <select class="slds-select" id="admin-date-range-select" style="width: 180px;">
                                        <option value="today" ${AppState.dateRange === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="this-week" ${AppState.dateRange === 'this-week' ? 'selected' : ''}>This Week</option>
                                        <option value="this-month" ${AppState.dateRange === 'this-month' ? 'selected' : ''}>This Month</option>
                                        <option value="last-30-days" ${AppState.dateRange === 'last-30-days' ? 'selected' : ''}>Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Department Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-combobox_container">
                                    <button class="slds-button slds-button_neutral">
                                        <span class="slds-truncate">All Departments</span>
                                        <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Office Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-combobox_container">
                                    <button class="slds-button slds-button_neutral">
                                        <span class="slds-truncate">All Offices</span>
                                        <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simplified Mission Control Layout -->
            <div style="margin-top: 1.5rem;">
                <!-- Row 1: System Health Status (Full Width) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 12;">
                        ${this.renderAdminSystemHealthCard(metrics)}
                    </div>
                </div>

                <!-- Row 2: Alerts + Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 8;">
                        ${this.renderAdminAlertsCard(metrics)}
                    </div>
                    <div style="grid-column: span 4;">
                        ${this.renderAdminQuickActionsCard()}
                    </div>
                </div>

                <!-- Row 3: Contextual Cards (Only shown when needed) -->
                ${metrics.setup.progress < 100 || metrics.users.connectionIssues > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    ${metrics.setup.progress < 100 ? `
                    <div style="grid-column: span ${metrics.users.connectionIssues > 0 ? '6' : '12'};">
                        ${this.renderAdminSetupCard(metrics)}
                    </div>
                    ` : ''}
                    ${metrics.users.connectionIssues > 0 ? `
                    <div style="grid-column: span ${metrics.setup.progress < 100 ? '6' : '12'};">
                        ${this.renderAdminUserConnectionCard(metrics)}
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
        `;
    },

    renderAdminAnalytics(metrics) {
        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate">Analytics</h1>
                                <p class="slds-page-header__meta-text">Company-wide metrics and reports</p>
                            </div>
                        </div>
                    </div>
                    <div class="slds-page-header__col-actions">
                        <div class="slds-page-header__controls">
                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" title="Refresh">
                                <svg class="slds-button__icon" aria-hidden="true">
                                    <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#refresh")}"></use>
                                </svg>
                                <span class="slds-assistive-text">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="slds-page-header__row slds-m-top_small">
                    <div class="slds-grid slds-grid_vertical-align-center" style="gap: 1.5rem;">
                        <!-- Date Range Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <select class="slds-select" id="admin-analytics-date-range-select" style="width: 180px;">
                                        <option value="today" ${AppState.dateRange === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="this-week" ${AppState.dateRange === 'this-week' ? 'selected' : ''}>This Week</option>
                                        <option value="this-month" ${AppState.dateRange === 'this-month' ? 'selected' : ''}>This Month</option>
                                        <option value="last-30-days" ${AppState.dateRange === 'last-30-days' ? 'selected' : ''}>Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Section -->
                        <div class="slds-grid slds-grid_vertical-align-center" style="gap: 0.5rem;">
                            <span class="slds-text-body_regular slds-text-color_weak">Filter by:</span>

                            <!-- Department Filter -->
                            <div class="slds-form-element">
                                <div class="slds-form-element__control">
                                    <div class="slds-combobox_container">
                                        <button class="slds-button slds-button_neutral">
                                            <span class="slds-truncate">All Departments</span>
                                            <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Office Filter -->
                            <div class="slds-form-element">
                                <div class="slds-form-element__control">
                                    <div class="slds-combobox_container">
                                        <button class="slds-button slds-button_neutral">
                                            <span class="slds-truncate">All Offices</span>
                                            <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <!-- Company Metrics -->
                <div style="margin-bottom: 1rem;">
                    ${this.renderAdminCompanyMetricsCard(metrics)}
                </div>

                <!-- Activity by Channel Chart -->
                <div style="margin-bottom: 1rem;">
                    <div class="slds-card">
                        <div class="slds-card__header slds-grid">
                            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                <div class="slds-media__body">
                                    <h2 class="slds-card__header-title">Activity by Channel</h2>
                                    <p class="slds-text-body_small slds-text-color_weak">Last 24 hours</p>
                                </div>
                            </header>
                        </div>
                        <div class="slds-card__body slds-card__body_inner">
                            <canvas id="admin-analytics-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div>
                    ${this.renderAdminRecentActivityCard(metrics)}
                </div>
            </div>
        `;
    },

    renderAdminUsers(metrics) {
        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate">Users & Licenses</h1>
                                <p class="slds-page-header__meta-text">User management and capacity planning</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 6;">
                        ${this.renderAdminUserOverviewCard(metrics)}
                    </div>
                    <div style="grid-column: span 6;">
                        ${this.renderAdminLicenseCard(metrics)}
                    </div>
                </div>

                ${metrics.users.connectionIssues > 0 ? `
                <div style="margin-bottom: 1rem;">
                    ${this.renderAdminUserConnectionCard(metrics)}
                </div>
                ` : ''}
            </div>
        `;
    },

    renderAdminIntegration(metrics) {
        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate">Integration Health</h1>
                                <p class="slds-page-header__meta-text">Salesforce connection and sync status</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 6;">
                        ${this.renderAdminIntegrationCard(metrics)}
                    </div>
                    <div style="grid-column: span 6;">
                        ${this.renderAdminSetupCard(metrics)}
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminUpdates(metrics) {
        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate">Updates & Announcements</h1>
                                <p class="slds-page-header__meta-text">Product updates and release notes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                ${this.renderAdminAnnouncementsCard(metrics)}
            </div>
        `;
    },

    navigateAdminSection(sectionId) {
        this.currentAdminSection = sectionId;

        // Re-render the admin dashboard with new section
        const content = document.getElementById('main-content');
        const role = RoleManager.getRole();
        content.innerHTML = this.renderHomePage(role);

        // Re-attach event listeners
        this.attachBannerListeners();
        this.attachNotificationListeners();
        this.attachHomePageListeners(role);

        // Re-render charts if navigating to analytics
        if (sectionId === 'analytics') {
            setTimeout(() => this.renderAnalyticsCharts(), 100);
        }
    },

    renderAnalyticsCharts() {
        const activityCtx = document.getElementById('admin-analytics-chart');
        if (activityCtx) {
            const activityData = DataService.getActivityByChannel();
            new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: activityData.map(d => `${d.hour}:00`),
                    datasets: [
                        {
                            label: 'Calls',
                            data: activityData.map(d => d.calls),
                            borderColor: '#3A49DA',
                            backgroundColor: 'rgba(58, 73, 218, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'SMS',
                            data: activityData.map(d => d.sms),
                            borderColor: '#06A59A',
                            backgroundColor: 'rgba(6, 165, 154, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'WhatsApp',
                            data: activityData.map(d => d.whatsapp),
                            borderColor: '#F9A03F',
                            backgroundColor: 'rgba(249, 160, 63, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderDash: [10, 5]
                        },
                        {
                            label: 'Email',
                            data: activityData.map(d => d.email),
                            borderColor: '#C4699F',
                            backgroundColor: 'rgba(196, 105, 159, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderDash: [2, 2]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 10 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    },

    // Admin Dashboard Card Components

    renderAdminSystemHealthCard(metrics) {
        const health = metrics.systemHealth;
        const getStatusClass = (status) => {
            if (status === 'online') return 'status-connected';
            if (status === 'offline') return 'status-disconnected';
            return 'status-wrap-up';
        };
        const getStatusText = (status) => status.charAt(0).toUpperCase() + status.slice(1);

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">System Health</h2>
                            <p class="slds-text-body_small slds-text-color_weak">Real-time service status</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem;">
                        <div style="text-align: center;">
                            <div class="slds-badge ${getStatusClass(health.coreService)}" style="display: block; margin-bottom: 0.5rem;">
                                ${getStatusText(health.coreService)}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Core Service</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="slds-badge ${getStatusClass(health.voice)}" style="display: block; margin-bottom: 0.5rem;">
                                ${getStatusText(health.voice)}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Voice</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="slds-badge ${getStatusClass(health.chatSms)}" style="display: block; margin-bottom: 0.5rem;">
                                ${getStatusText(health.chatSms)}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Chat & SMS</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="slds-badge ${getStatusClass(health.analytics)}" style="display: block; margin-bottom: 0.5rem;">
                                ${getStatusText(health.analytics)}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Analytics</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="slds-badge ${getStatusClass(health.ai)}" style="display: block; margin-bottom: 0.5rem;">
                                ${getStatusText(health.ai)}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">AI</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="slds-badge ${getStatusClass(health.salesforceIntegration)}" style="display: block; margin-bottom: 0.5rem;">
                                ${getStatusText(health.salesforceIntegration)}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Salesforce</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminAlertsCard(metrics) {
        const alerts = metrics.alerts;
        const getAlertIcon = (type) => {
            if (type === 'warning') return 'warning';
            if (type === 'error') return 'error';
            return 'info';
        };
        const getAlertClass = (type) => {
            if (type === 'warning') return 'slds-icon-text-warning';
            if (type === 'error') return 'slds-icon-text-error';
            return 'slds-icon-text-default';
        };

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Attention Required</h2>
                            <p class="slds-text-body_small slds-text-color_weak">${alerts.length} alert${alerts.length !== 1 ? 's' : ''}</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    ${alerts.length === 0 ? `
                        <div style="text-align: center; padding: 2rem;">
                            <svg class="slds-icon slds-icon_large slds-icon-text-success" aria-hidden="true">
                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#check")}"></use>
                            </svg>
                            <p class="slds-m-top_small">All systems running smoothly</p>
                        </div>
                    ` : `
                        <ul class="slds-has-dividers_top-space">
                            ${alerts.map(alert => `
                                <li class="slds-item slds-p-vertical_small">
                                    <div class="slds-grid slds-grid_vertical-align-center">
                                        <div class="slds-col slds-size_1-of-12">
                                            <span class="slds-icon_container" title="${alert.type}">
                                                <svg class="slds-icon slds-icon_x-small ${getAlertClass(alert.type)}" aria-hidden="true">
                                                    <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${getAlertIcon(alert.type)}`)}"></use>
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="slds-col slds-size_11-of-12">
                                            <span class="slds-text-body_regular">${alert.message}</span>
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    `}
                </div>
            </div>
        `;
    },

    renderAdminUserOverviewCard(metrics) {
        const users = metrics.users;
        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/settings'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">User Overview</h2>
                            <p class="slds-text-body_small slds-text-color_weak">User provisioning & status</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${users.total}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Total Users</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${users.activeToday}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Active Today</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: ${users.connectionIssues > 0 ? '#c23934' : '#001642'};">${users.connectionIssues}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Connection Issues</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${users.neverLoggedIn}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Never Logged In</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dddbda;">
                        <div class="slds-text-body_small slds-text-color_weak">Recent Changes</div>
                        <div style="font-size: 0.875rem; margin-top: 0.25rem;">3 users added this week</div>
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminUserConnectionCard(metrics) {
        const users = metrics.users;
        const allUsers = DataService.getUsers('admin');
        const usersWithIssues = allUsers.filter((u, i) => i < users.connectionIssues); // Mock: first N users have issues

        return `
            <div class="slds-card" style="height: 100%; cursor: pointer; transition: all 0.2s ease;"
                 onclick="window.location.hash='#/settings'"
                 onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'"
                 onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                <span class="slds-badge status-disconnected" style="margin-right: 0.5rem;">${users.connectionIssues}</span>
                                Connection Issues
                            </h2>
                            <p class="slds-text-body_small slds-text-color_weak">Requires attention</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <ul style="list-style: none; margin: 0; padding: 0;">
                        ${usersWithIssues.map(user => `
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid #f3f3f3;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600;">${user.name}</div>
                                        <div class="slds-text-body_small slds-text-color_weak">${user.role}</div>
                                    </div>
                                    <div class="slds-badge status-disconnected">Disconnected</div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                    <div style="margin-top: 1rem; text-align: center;">
                        <span class="slds-text-link" style="color: #3A49DA; font-weight: 600;">View All Users →</span>
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminLicenseCard(metrics) {
        const licenses = metrics.licenses;
        const utilizationColor = licenses.utilization > 85 ? '#c23934' : licenses.utilization > 70 ? '#e07c3e' : '#04844b';

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">License Utilization</h2>
                            <p class="slds-text-body_small slds-text-color_weak">Capacity planning</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="slds-text-body_regular">${licenses.used} of ${licenses.total} licenses used</span>
                            <span class="slds-text-body_regular" style="color: ${utilizationColor}; font-weight: 600;">${licenses.utilization}%</span>
                        </div>
                        <div class="slds-progress-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${licenses.utilization}" role="progressbar">
                            <span class="slds-progress-bar__value" style="width: ${licenses.utilization}%; background-color: ${utilizationColor};">
                                <span class="slds-assistive-text">${licenses.utilization}%</span>
                            </span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #001642;">${licenses.available}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Licenses Available</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #001642;">5</div>
                            <div class="slds-text-body_small slds-text-color_weak">New This Month</div>
                        </div>
                    </div>
                    ${licenses.utilization > 85 ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background-color: #ffeaa8; border-radius: 0.25rem;">
                            <div class="slds-text-body_small">
                                <strong>Action Recommended:</strong> Consider purchasing additional licenses
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    },

    renderAdminIntegrationCard(metrics) {
        const integration = metrics.integration;
        const apiUsagePercent = Math.round((integration.apiUsage / integration.apiLimit) * 100);
        const timeSinceSync = integration.lastSync ? Math.floor((Date.now() - integration.lastSync.getTime()) / 60000) : null;
        const isConnected = integration.status === 'connected';

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Salesforce Integration</h2>
                            <p class="slds-text-body_small slds-text-color_weak">Connection & sync status</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
                        <div>
                            <div class="slds-badge ${isConnected ? 'status-connected' : 'status-disconnected'}" style="display: inline-block; margin-bottom: 0.5rem;">
                                ${isConnected ? 'Connected' : 'Disconnected'}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Status</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: ${isConnected ? '#001642' : '#c23934'};">
                                ${timeSinceSync !== null ? `${timeSinceSync}m ago` : 'Never'}
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">Last Sync</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="slds-text-body_small">API Usage Today</span>
                            <span class="slds-text-body_small">${integration.apiUsage} / ${integration.apiLimit} (${apiUsagePercent}%)</span>
                        </div>
                        <div class="slds-progress-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${apiUsagePercent}" role="progressbar">
                            <span class="slds-progress-bar__value" style="width: ${apiUsagePercent}%;">
                                <span class="slds-assistive-text">${apiUsagePercent}%</span>
                            </span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: ${integration.errorCount24h > 0 ? '#c23934' : '#04844b'};">${integration.errorCount24h}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Errors (24h)</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: #001642;">${integration.permissionSetsAssigned}/${integration.permissionSetsTotal}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Permission Sets</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="slds-button slds-button_neutral slds-button_stretch">Test Connection</button>
                        <button class="slds-button slds-button_neutral slds-button_stretch">View Logs</button>
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminSetupCard(metrics) {
        const setup = metrics.setup;
        const getStepIcon = (status) => {
            if (status === 'completed') return 'check';
            if (status === 'in-progress') return 'warning';
            return 'close';
        };
        const getStepClass = (status) => {
            if (status === 'completed') return 'slds-icon-text-success';
            if (status === 'in-progress') return 'slds-icon-text-warning';
            return 'slds-icon-text-default';
        };

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Setup Progress</h2>
                            <p class="slds-text-body_small slds-text-color_weak">${setup.completed} of ${setup.total} steps complete (${setup.progress}%)</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-progress-bar slds-progress-bar_large slds-m-bottom_medium" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${setup.progress}" role="progressbar">
                        <span class="slds-progress-bar__value" style="width: ${setup.progress}%;">
                            <span class="slds-assistive-text">${setup.progress}%</span>
                        </span>
                    </div>
                    <ul class="slds-has-dividers_top-space">
                        ${setup.steps.map(step => `
                            <li class="slds-item slds-p-vertical_small">
                                <div class="slds-grid slds-grid_vertical-align-center slds-grid_align-spread">
                                    <div class="slds-col slds-no-flex slds-m-right_small">
                                        <span class="slds-icon_container">
                                            <svg class="slds-icon slds-icon_x-small ${getStepClass(step.status)}" aria-hidden="true">
                                                <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${getStepIcon(step.status)}`)}></use>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="slds-col slds-has-flexi-truncate">
                                        <span class="slds-text-body_regular slds-text-color_default">${step.name}</span>
                                    </div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `;
    },

    renderAdminCompanyMetricsCard(metrics) {
        const calls = metrics.calls;
        const pickupRate = Math.round(((calls.total - calls.missed) / calls.total) * 100);

        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/calls'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Company-Wide Metrics</h2>
                            <p class="slds-text-body_small slds-text-color_weak">Today's performance</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${calls.total}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Total Calls</div>
                            <div class="slds-text-body_small metric-positive">+12% vs yesterday</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${DataService.formatDuration(calls.avgDuration)}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Avg Duration</div>
                            <div class="slds-text-body_small">Across all calls</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: ${calls.missed > 20 ? '#c23934' : '#001642'};">${calls.missed}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Missed Calls</div>
                            <div class="slds-text-body_small">${Math.round((calls.missed / calls.total) * 100)}% of total</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${calls.serviceScore}%</div>
                            <div class="slds-text-body_small slds-text-color_weak">Service Score</div>
                            <div class="slds-text-body_small metric-positive">Above target</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderAdminAnnouncementsCard(metrics) {
        const announcements = metrics.announcements.filter(a => !a.read).slice(0, 3);

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Product Announcements</h2>
                            <p class="slds-text-body_small slds-text-color_weak">${announcements.length} unread</p>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <a href="#" class="slds-text-link">View All</a>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    ${announcements.length === 0 ? `
                        <div style="text-align: center; padding: 1.5rem;">
                            <p class="slds-text-color_weak">No new announcements</p>
                        </div>
                    ` : `
                        <ul class="slds-has-dividers_top-space">
                            ${announcements.map(announcement => `
                                <li class="slds-item slds-p-vertical_medium">
                                    <h3 class="slds-text-heading_small">${announcement.title}</h3>
                                    <p class="slds-text-body_small slds-m-top_x-small">${announcement.message}</p>
                                    <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                                        ${this.formatRelativeTime(announcement.date)}
                                    </p>
                                </li>
                            `).join('')}
                        </ul>
                    `}
                </div>
            </div>
        `;
    },

    renderAdminQuickActionsCard() {
        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Quick Actions</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <ul class="slds-has-dividers_bottom-space">
                        <li class="slds-item slds-p-vertical_small">
                            <button class="slds-button slds-button_neutral slds-button_stretch" onclick="window.location.hash='#/settings'">
                                <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                    <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#add")}"></use>
                                </svg>
                                Add User
                            </button>
                        </li>
                        <li class="slds-item slds-p-vertical_small">
                            <button class="slds-button slds-button_neutral slds-button_stretch">
                                <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                    <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#upload")}"></use>
                                </svg>
                                Bulk Import
                            </button>
                        </li>
                        <li class="slds-item slds-p-vertical_small">
                            <button class="slds-button slds-button_neutral slds-button_stretch">
                                <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                    <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#check")}"></use>
                                </svg>
                                Run Health Check
                            </button>
                        </li>
                        <li class="slds-item slds-p-vertical_small">
                            <button class="slds-button slds-button_neutral slds-button_stretch" onclick="window.location.hash='#/settings'">
                                <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                    <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#settings")}"></use>
                                </svg>
                                Manage Permissions
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        `;
    },

    renderAdminRecentActivityCard(metrics) {
        const activities = metrics.recentActivity.slice(0, 5);
        const getActivityIcon = (type) => {
            if (type === 'config') return 'settings';
            if (type === 'user') return 'user';
            if (type === 'error') return 'error';
            return 'info';
        };
        const getActivityClass = (type) => {
            if (type === 'error') return 'background-color: #ffe3e3;';
            if (type === 'config') return 'background-color: #ffeaa8;';
            return '';
        };

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Recent Activity</h2>
                            <p class="slds-text-body_small slds-text-color_weak">System audit log</p>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <button class="slds-button slds-button_neutral">Export</button>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 20%;">Time</th>
                                <th scope="col" style="width: 25%;">User</th>
                                <th scope="col" style="width: 55%;">Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(activity => `
                                <tr style="${getActivityClass(activity.type)}">
                                    <td>${this.formatRelativeTime(activity.timestamp)}</td>
                                    <td>${activity.user}</td>
                                    <td>
                                        <div class="slds-grid slds-grid_vertical-align-center">
                                            <svg class="slds-icon slds-icon_x-small slds-m-right_x-small" aria-hidden="true">
                                                <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${getActivityIcon(activity.type)}`)}></use>
                                            </svg>
                                            ${activity.activity}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    formatRelativeTime(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // seconds

        if (diff < 60) return `${diff}s ago`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
    },

    renderSupervisorDashboard() {
        const metrics = DataService.getSupervisorMetrics();
        const agentStatus = DataService.getAgentStatusList();
        const rankingsByCCs = DataService.getRankingsByCCs();
        const rankingsByAgents = DataService.getRankingsByAgents();

        return `
            ${this.getAlertBannersHTML()}

            <!-- Page Header with Filters and Time Period -->
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="Supervisor Dashboard">Team Dashboard</h1>
                                <p class="slds-page-header__meta-text">Team performance and agent activity</p>
                            </div>
                        </div>
                    </div>
                    <div class="slds-page-header__col-actions">
                        <button class="slds-button slds-button_icon slds-button_icon-border-filled" title="Refresh">
                            <svg class="slds-button__icon" aria-hidden="true">
                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#refresh")}"></use>
                            </svg>
                            <span class="slds-assistive-text">Refresh</span>
                        </button>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="slds-page-header__row slds-m-top_small">
                    <div class="slds-grid slds-grid_vertical-align-center" style="gap: 1rem;">
                        <!-- Date Range Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <select class="slds-select" id="supervisor-date-range-select" style="width: 180px;">
                                        <option value="today" ${AppState.dateRange === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="this-week" ${AppState.dateRange === 'this-week' ? 'selected' : ''}>This Week</option>
                                        <option value="this-month" ${AppState.dateRange === 'this-month' ? 'selected' : ''}>This Month</option>
                                        <option value="last-30-days" ${AppState.dateRange === 'last-30-days' ? 'selected' : ''}>Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Centers Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-combobox_container">
                                    <button class="slds-button slds-button_neutral">
                                        <span class="slds-truncate">All Contact Centers</span>
                                        <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Agents Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-combobox_container">
                                    <button class="slds-button slds-button_neutral">
                                        <span class="slds-truncate">All Agents</span>
                                        <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row-Based Bento Box Layout -->
            <div style="margin-top: 1.5rem;">
                <!-- Row 1: Team Status (Most Important - Full Width) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 12;">
                        ${this.renderTeamStatusCard(agentStatus, metrics)}
                    </div>
                </div>

                <!-- Row 2: Alerts + Team Performance (Urgent Info First) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 6;">
                        ${this.renderAlertsCard(metrics, agentStatus)}
                    </div>
                    <div style="grid-column: span 6;">
                        ${this.renderTeamPerformanceCard(metrics)}
                    </div>
                </div>

                <!-- Row 3: Unlogged Calls (Full Width - Data Quality Issue) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 12;">
                        ${this.renderUnloggedCallsCard(metrics)}
                    </div>
                </div>

                <!-- Row 4: Powerdialer Activity + Handled Calls (Equal Height) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 6;">
                        ${this.renderPowerdialerActivityCard()}
                    </div>
                    <div style="grid-column: span 6;">
                        ${this.renderHandledCallsCard(metrics)}
                    </div>
                </div>

                <!-- Row 5: AI Scorecards + AI Agent (Equal Height) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 6;">
                        ${this.renderAIScorecardsCard(metrics)}
                    </div>
                    <div style="grid-column: span 6;">
                        ${this.renderAIAgentCard(metrics)}
                    </div>
                </div>

                <!-- Row 6: AI CSAT + Rankings (Equal Height) -->
                <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="grid-column: span 6;">
                        ${this.renderAICSATCard(metrics)}
                    </div>
                    <div style="grid-column: span 6;">
                        ${this.renderRankingsCard(rankingsByCCs, rankingsByAgents)}
                    </div>
                </div>
            </div>
        `;
    },

    // Supervisor Dashboard Card Components

    renderTeamPerformanceCard(metrics) {
        const teamCalls = DataService.getCalls('supervisor');
        const teamUsers = DataService.getUsers('supervisor');
        const agents = teamUsers.filter(u => u.role === 'Agent');

        // Calculate team-wide metrics
        const totalCalls = teamCalls.length;
        const avgHandleTime = metrics.avgHandleTime;
        const teamPickupRate = Math.round((totalCalls - metrics.missedCalls) / totalCalls * 100);
        const teamCSAT = metrics.aiCsat.score;

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Team Performance</h2>
                            <p class="slds-text-body_small slds-text-color_weak">Today's aggregate metrics</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${totalCalls}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Total Calls</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${DataService.formatDuration(avgHandleTime)}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Avg Handle Time</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${teamPickupRate}%</div>
                            <div class="slds-text-body_small slds-text-color_weak">Team Pickup Rate</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${teamCSAT}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Team CSAT</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderPowerdialerActivityCard() {
        const lists = DataService.getLists('supervisor');
        const activeLists = lists.filter(l => l.status === 'Active');
        const totalContactsRemaining = activeLists.reduce((sum, l) => sum + l.contactsRemaining, 0);
        const callsFromListsToday = 87; // Mock data
        const topList = activeLists.length > 0 ? activeLists[0] : null;

        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/powerdialer'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Powerdialer Activity</h2>
                            <p class="slds-text-body_small slds-text-color_weak">Today's list progress</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${activeLists.length}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Active Lists</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: #001642;">${totalContactsRemaining}</div>
                            <div class="slds-text-body_small slds-text-color_weak">Contacts Remaining</div>
                        </div>
                    </div>
                    <div style="padding-top: 1rem; border-top: 1px solid #dddbda;">
                        <div class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">Calls from lists today</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #001642;">${callsFromListsToday}</div>
                        ${topList ? `
                        <div class="slds-text-body_small slds-text-color_weak slds-m-top_small">
                            Top list: <strong>${topList.name}</strong>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    },

    renderAlertsCard(metrics, agentStatus) {
        const offlineAgents = agentStatus.filter(a => a.state === 'Offline');
        const agentsWithUnloggedCalls = 3; // Mock: agents with >5 unlogged calls
        const highMissedCallRate = metrics.missedCalls > (metrics.handledCalls.total * 0.1);

        const alerts = [];
        if (offlineAgents.length > 0) {
            alerts.push({ type: 'warning', message: `${offlineAgents.length} agent${offlineAgents.length > 1 ? 's' : ''} offline` });
        }
        if (agentsWithUnloggedCalls > 0) {
            alerts.push({ type: 'warning', message: `${agentsWithUnloggedCalls} agents with unlogged calls` });
        }
        if (highMissedCallRate) {
            alerts.push({ type: 'error', message: `High missed call rate: ${metrics.missedCalls} missed` });
        }

        if (alerts.length === 0) {
            alerts.push({ type: 'success', message: 'All systems running smoothly' });
        }

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Attention Needed</h2>
                            <p class="slds-text-body_small slds-text-color_weak">${alerts.length} alert${alerts.length > 1 ? 's' : ''}</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <ul class="slds-has-dividers_top-space">
                        ${alerts.map(alert => `
                            <li class="slds-item slds-p-vertical_small">
                                <div class="slds-grid slds-grid_vertical-align-center">
                                    <div class="slds-col slds-size_1-of-12">
                                        <span class="slds-icon_container ${alert.type === 'error' ? 'slds-icon-utility-error' : alert.type === 'warning' ? 'slds-icon-utility-warning' : 'slds-icon-utility-success'}" title="${alert.type}">
                                            <svg class="slds-icon slds-icon_x-small ${alert.type === 'error' ? 'slds-icon-text-error' : alert.type === 'warning' ? 'slds-icon-text-warning' : 'slds-icon-text-success'}" aria-hidden="true">
                                                <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${alert.type === 'success' ? 'check' : alert.type}`)}"></use>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="slds-col slds-size_11-of-12">
                                        <span class="slds-text-body_regular">${alert.message}</span>
                                    </div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `;
    },

    renderHandledCallsCard(metrics) {
        const { handledCalls } = metrics;
        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/calls'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Handled Calls</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-m-bottom_medium">
                        <div style="font-size: 3rem; font-weight: 700; color: #001642; line-height: 1;">${handledCalls.total}</div>
                        <p class="slds-text-body_small slds-text-color_weak">Calls today</p>
                    </div>
                    <div class="chart-placeholder">
                        <p class="slds-text-color_weak">Chart shows up here</p>
                    </div>
                    <div class="slds-m-top_medium">
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_x-small">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #6B46C1; margin-right: 0.5rem;"></span>
                            <span class="slds-text-body_small">Inbound: ${handledCalls.inbound}</span>
                        </div>
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_x-small">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #C4699F; margin-right: 0.5rem;"></span>
                            <span class="slds-text-body_small">Outbound: ${handledCalls.outbound}</span>
                        </div>
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #F9A03F; margin-right: 0.5rem;"></span>
                            <span class="slds-text-body_small">Connected call-backs: ${handledCalls.callbacks}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderTeamStatusCard(agentStatus, metrics) {
        const getStateClass = (state) => {
            const stateMap = {
                'On Call': 'state-on-call',
                'Available': 'state-available',
                'Wrap-Up': 'state-wrap-up',
                'Break': 'state-break',
                'Offline': 'state-offline'
            };
            return stateMap[state] || 'state-offline';
        };

        // Get full user data for additional info
        const teamUsers = DataService.getUsers('supervisor');
        const agentRows = agentStatus.map(agent => {
            const userData = teamUsers.find(u => u.id === agent.id);

            // Visual indicator for state
            const stateIcon = {
                'On Call': 'phone',
                'Available': 'success',
                'Wrap-Up': 'clock',
                'Break': 'away',
                'Offline': 'offline'
            };

            return `
                <tr class="slds-hint-parent" style="cursor: pointer; transition: background-color 0.2s ease;" onclick="window.location.hash='#/team'" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor=''">
                    <td data-label="Agent" style="padding: 0.375rem 0.75rem;">
                        <div style="font-weight: 600; white-space: nowrap;">${agent.name}</div>
                        <div class="slds-text-body_small slds-text-color_weak">${userData?.department || 'N/A'}</div>
                    </td>
                    <td data-label="Status" style="padding: 0.375rem 0.75rem;">
                        <div class="slds-grid slds-grid_vertical-align-center" style="gap: 0.25rem;">
                            <svg class="slds-icon slds-icon_x-small" style="width: 0.75rem; height: 0.75rem; fill: ${agent.state === 'On Call' ? '#3A49DA' : agent.state === 'Available' ? '#4bca81' : '#706e6b'};">
                                <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${stateIcon[agent.state] || 'user'}`)}"></use>
                            </svg>
                            <span class="slds-badge ${getStateClass(agent.state)}" style="font-size: 0.75rem;">${agent.state}</span>
                            <span class="slds-text-body_small slds-text-color_weak" style="margin-left: 0.25rem;">${agent.stateDuration}</span>
                        </div>
                    </td>
                    <td data-label="Extension" style="padding: 0.375rem 0.75rem;">
                        <span class="slds-text-body_small">${agent.extension}</span>
                    </td>
                    <td data-label="Calls Today" style="padding: 0.375rem 0.75rem; text-align: center;">
                        <span style="font-weight: 600;">${userData?.callsToday || 0}</span>
                    </td>
                    <td data-label="Pickup Rate" style="padding: 0.375rem 0.75rem; text-align: center;">
                        <span style="font-weight: 600; color: ${(userData?.pickupRate || 0) >= 90 ? '#4bca81' : (userData?.pickupRate || 0) >= 70 ? '#e07c3e' : '#c23934'};">${userData?.pickupRate || 0}%</span>
                    </td>
                </tr>
            `;
        }).join('');

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Team Status</h2>
                            <p class="slds-text-body_small slds-text-color_weak">${metrics.activeAgents.active} of ${metrics.activeAgents.total} active</p>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body" style="padding: 0;">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_fixed-layout">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col" style="width: 25%;">
                                        <div class="slds-truncate" title="Agent">Agent</div>
                                    </th>
                                    <th scope="col" style="width: 25%;">
                                        <div class="slds-truncate" title="Status">Status</div>
                                    </th>
                                    <th scope="col" style="width: 15%;">
                                        <div class="slds-truncate" title="Extension">Extension</div>
                                    </th>
                                    <th scope="col" style="width: 17.5%;">
                                        <div class="slds-truncate" title="Calls Today">Calls Today</div>
                                    </th>
                                    <th scope="col" style="width: 17.5%;">
                                        <div class="slds-truncate" title="Pickup Rate">Pickup Rate</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${agentRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    },

    renderAIScorecardsCard(metrics) {
        const { aiScorecard } = metrics;
        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Ai Scorecards</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-m-bottom_medium">
                        <div style="font-size: 3rem; font-weight: 700; color: #3A49DA; line-height: 1;">${aiScorecard.average}%</div>
                        <p class="slds-text-body_small slds-text-color_weak">Out of 100%</p>
                    </div>
                    <div class="chart-placeholder">
                        <p class="slds-text-color_weak">Chart shows up here</p>
                    </div>
                </div>
            </div>
        `;
    },

    renderAIAgentCard(metrics) {
        const { aiAgent } = metrics;
        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Ai Agent</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-m-bottom_medium">
                        <div style="font-size: 2rem; font-weight: 700; color: #001642; line-height: 1;">${aiAgent.totalSessions}</div>
                        <p class="slds-text-body_small slds-text-color_weak">Total sessions</p>
                    </div>
                    <div class="chart-placeholder" style="margin-bottom: 1rem;">
                        <p class="slds-text-color_weak">Chart shows up here</p>
                    </div>
                    <div class="slds-text-align_center slds-m-bottom_small">
                        <div style="font-size: 1.25rem; font-weight: 600; color: #706e6b;">Deflection Rate</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #3A49DA;">${aiAgent.deflectionRate}%</div>
                    </div>
                    <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_x-small">
                        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #6B46C1; margin-right: 0.5rem;"></span>
                        <span class="slds-text-body_small">Automated: ${aiAgent.automated}</span>
                    </div>
                    <div class="slds-grid slds-grid_vertical-align-center">
                        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #C4699F; margin-right: 0.5rem;"></span>
                        <span class="slds-text-body_small">Not automated: ${aiAgent.notAutomated}</span>
                    </div>
                </div>
            </div>
        `;
    },

    renderUnloggedCallsCard(metrics) {
        const { unloggedCalls } = metrics;
        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Unlogged calls</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-table_fixed-layout" style="table-layout: auto;">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 25%;">User ID</th>
                                <th scope="col" style="width: 25%;">User name</th>
                                <th scope="col" style="width: 25%;">Instance URL</th>
                                <th scope="col" style="width: 15%;">Instance type</th>
                                <th scope="col" style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${unloggedCalls.map((call, index) => `
                                <tr style="cursor: pointer; transition: background-color 0.2s ease; ${index === 3 ? 'background-color: #ffebe8;' : ''}" onclick="window.location.hash='#/calls'" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor='${index === 3 ? '#ffebe8' : ''}'">
                                    <td><span class="slds-text-body_small">${call.userId}</span></td>
                                    <td><span class="slds-text-body_small">${call.userName}</span></td>
                                    <td><span class="slds-text-body_small slds-truncate" title="${call.contact}">${call.contact}</span></td>
                                    <td><span class="slds-text-body_small">Call</span></td>
                                    <td><button class="slds-button slds-button_icon" title="More actions" onclick="event.stopPropagation();">
                                        <svg class="slds-button__icon" style="width: 1rem; height: 1rem;">
                                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                        </svg>
                                    </button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderRankingsCard(rankingsByCCs, rankingsByAgents) {
        const cardId = 'rankings-card-' + Date.now();

        return `
            <div class="slds-card" style="height: 100%;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Rankings</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <!-- Tabs -->
                    <div class="slds-tabs_default">
                        <ul class="slds-tabs_default__nav" role="tablist">
                            <li class="slds-tabs_default__item slds-is-active" role="presentation">
                                <a class="slds-tabs_default__link" href="#tab-ccs-${cardId}" role="tab" id="tab-label-ccs-${cardId}" onclick="event.preventDefault(); App.switchRankingsTab('ccs', '${cardId}')">By CCs</a>
                            </li>
                            <li class="slds-tabs_default__item" role="presentation">
                                <a class="slds-tabs_default__link" href="#tab-agents-${cardId}" role="tab" id="tab-label-agents-${cardId}" onclick="event.preventDefault(); App.switchRankingsTab('agents', '${cardId}')">By agents</a>
                            </li>
                        </ul>

                        <!-- Tab Content: CCs -->
                        <div id="tab-ccs-${cardId}" class="slds-tabs_default__content slds-show slds-p-around_none" role="tabpanel">
                            <table class="slds-table slds-table_cell-buffer" style="table-layout: auto;">
                                <tbody>
                                    ${rankingsByCCs.map((item, index) => `
                                        <tr style="cursor: pointer; transition: background-color 0.2s ease;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor=''">
                                            <td style="width: 10%; padding: 0.5rem;">${index + 1}</td>
                                            <td style="width: 60%; padding: 0.5rem;"><span>${item.name}</span></td>
                                            <td style="width: 30%; padding: 0.5rem; text-align: right;"><strong>${item.score}%</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Tab Content: Agents -->
                        <div id="tab-agents-${cardId}" class="slds-tabs_default__content slds-hide slds-p-around_none" role="tabpanel">
                            <table class="slds-table slds-table_cell-buffer" style="table-layout: auto;">
                                <tbody>
                                    ${rankingsByAgents.map((item, index) => `
                                        <tr style="cursor: pointer; transition: background-color 0.2s ease;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor=''">
                                            <td style="width: 10%; padding: 0.5rem;">${index + 1}</td>
                                            <td style="width: 60%; padding: 0.5rem;"><span>+ ${item.name}</span></td>
                                            <td style="width: 30%; padding: 0.5rem; text-align: right;"><strong>${item.score}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    switchRankingsTab(tabType, cardId) {
        // Update tab active state
        const ccsTab = document.querySelector(`#tab-label-ccs-${cardId}`).parentElement;
        const agentsTab = document.querySelector(`#tab-label-agents-${cardId}`).parentElement;
        const ccsContent = document.getElementById(`tab-ccs-${cardId}`);
        const agentsContent = document.getElementById(`tab-agents-${cardId}`);

        if (tabType === 'ccs') {
            ccsTab.classList.add('slds-is-active');
            agentsTab.classList.remove('slds-is-active');
            ccsContent.classList.remove('slds-hide');
            ccsContent.classList.add('slds-show');
            agentsContent.classList.remove('slds-show');
            agentsContent.classList.add('slds-hide');
        } else {
            agentsTab.classList.add('slds-is-active');
            ccsTab.classList.remove('slds-is-active');
            agentsContent.classList.remove('slds-hide');
            agentsContent.classList.add('slds-show');
            ccsContent.classList.remove('slds-show');
            ccsContent.classList.add('slds-hide');
        }
    },

    renderAICSATCard(metrics) {
        const { aiCsat } = metrics;
        return `
            <div class="slds-card clickable-card" style="cursor: pointer; transition: all 0.2s ease; height: 100%;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Ai CSAT</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-m-bottom_medium">
                        <div style="font-size: 3rem; font-weight: 700; color: #3A49DA; line-height: 1;">★ ${aiCsat.score}</div>
                        <p class="slds-text-body_small slds-text-color_weak">${aiCsat.totalResponses} responses</p>
                    </div>
                    <div class="chart-placeholder">
                        <p class="slds-text-color_weak">Chart shows up here</p>
                    </div>
                </div>
            </div>
        `;
    },

    renderAgentDashboard() {
        const metrics = DataService.getMetrics('agent');
        const currentUserId = window.RoleManager?.currentUserId || '005xx000001X8Uz';
        const quota = AppState.getQuotaStatus(currentUserId);

        return `
            ${this.getAlertBannersHTML()}

            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="My Dashboard">My Dashboard</h1>
                                <p class="slds-page-header__meta-text">Personal activity and performance</p>
                            </div>
                        </div>
                    </div>
                    <div class="slds-page-header__col-actions">
                        <button class="slds-button slds-button_icon slds-button_icon-border-filled" title="Refresh">
                            <svg class="slds-button__icon" aria-hidden="true">
                                <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#refresh")}"></use>
                            </svg>
                            <span class="slds-assistive-text">Refresh</span>
                        </button>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="slds-page-header__row slds-m-top_small">
                    <div class="slds-grid slds-grid_vertical-align-center" style="gap: 1rem;">
                        <!-- Date Range Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <select class="slds-select" id="agent-date-range-select" style="width: 180px;">
                                        <option value="today" ${AppState.dateRange === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="this-week" ${AppState.dateRange === 'this-week' ? 'selected' : ''}>This Week</option>
                                        <option value="this-month" ${AppState.dateRange === 'this-month' ? 'selected' : ''}>This Month</option>
                                        <option value="last-30-days" ${AppState.dateRange === 'last-30-days' ? 'selected' : ''}>Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Call Type Filter -->
                        <div class="slds-form-element">
                            <div class="slds-form-element__control">
                                <div class="slds-combobox_container">
                                    <button class="slds-button slds-button_neutral">
                                        <span class="slds-truncate">All Call Types</span>
                                        <svg class="slds-button__icon slds-button__icon_right" style="width: 0.875rem; height: 0.875rem; margin-left: 0.5rem;">
                                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#down")}"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6 Metric Cards -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <div class="slds-card metric-card metric-card-clickable" data-metric="calls" style="cursor: pointer;">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="metric-label">Calls</div>
                        <div class="metric-value">${metrics.calls}</div>
                    </div>
                </div>
                <div class="slds-card metric-card metric-card-clickable" data-metric="quota" style="cursor: pointer;">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="metric-label">Quota</div>
                        <div class="metric-value">${quota.made}/${quota.target}</div>
                    </div>
                </div>
                <div class="slds-card metric-card metric-card-clickable" data-metric="service-score" style="cursor: pointer;">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="metric-label">Service Score</div>
                        <div class="metric-value">${metrics.serviceScore}%</div>
                    </div>
                </div>
                <div class="slds-card metric-card metric-card-clickable" data-metric="calls-per-hour" style="cursor: pointer;">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="metric-label">Calls/Hour</div>
                        <div class="metric-value">${metrics.callsPerHour}</div>
                    </div>
                </div>
                <div class="slds-card metric-card metric-card-clickable" data-metric="avg-duration" style="cursor: pointer;">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="metric-label">Avg Duration</div>
                        <div class="metric-value">${DataService.formatDuration(metrics.avgCallDuration)}</div>
                    </div>
                </div>
                <div class="slds-card metric-card metric-card-clickable" data-metric="missed-calls" style="cursor: pointer;">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="metric-label">Missed Calls</div>
                        <div class="metric-value">${metrics.missedCalls}</div>
                    </div>
                </div>
            </div>

            <!-- Bento Box Grid Layout -->
            <div class="slds-m-top_medium" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; grid-auto-rows: minmax(min-content, max-content);">

                <!-- Row 1: Quota Progress (full width) -->
                <div style="grid-column: span 12;">
                    ${this.renderQuotaProgress()}
                </div>

                <!-- Row 2: Open Cases (full width) - CRM Integration -->
                <div style="grid-column: span 12;">
                    ${this.renderOpenCasesWidget()}
                </div>

                <!-- Row 3: Call Type Breakdown, Work Time, AI CSAT (equal heights) -->
                <div style="grid-column: span 4; display: flex;">
                    <div style="flex: 1;">${this.renderCallTypeBreakdown(metrics)}</div>
                </div>
                <div style="grid-column: span 4; display: flex;">
                    <div style="flex: 1;">${this.renderWorkTimeToday(metrics.workTime)}</div>
                </div>
                <div style="grid-column: span 4; display: flex;">
                    <div style="flex: 1;">${this.renderAICsatChart()}</div>
                </div>

                <!-- Row 4: Powerdialer Queue (left), Unlogged Calls (right) (equal heights) -->
                <div style="grid-column: span 6; display: flex;">
                    <div style="flex: 1;">${this.renderPowerdialerQueue()}</div>
                </div>
                <div style="grid-column: span 6; display: flex;">
                    <div style="flex: 1;">${this.renderUnloggedCallsStandalone()}</div>
                </div>

                <!-- Row 5: Powerdialer Lists (full width) -->
                <div style="grid-column: span 12;">
                    ${this.renderPowerdialerListsEnhanced()}
                </div>

                <!-- Row 6: Recent Calls (full width) -->
                <div style="grid-column: span 12;">
                    ${this.renderRecentCallsAgent()}
                </div>

            </div>
        `;
    },

    renderCallsPage(role) {
        const calls = DataService.getCalls(role);

        // Define views based on role
        const views = role === 'agent'
            ? [
                { id: 'my-calls', label: 'My Calls', default: true },
                { id: 'all-calls', label: 'All Calls', default: false }
            ]
            : role === 'supervisor'
            ? [
                { id: 'my-calls', label: 'My Calls', default: false },
                { id: 'team-calls', label: 'My Team', default: true },
                { id: 'all-calls', label: 'All Calls', default: false }
            ]
            : [
                // Admin: no "My Calls" - admins don't typically make calls
                { id: 'team-calls', label: 'My Team', default: true },
                { id: 'all-calls', label: 'All Calls', default: false }
            ];

        const defaultView = views.find(v => v.default).id;

        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="Calls">Calls</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Selector (Predefined Views) -->
            <div class="slds-m-bottom_medium">
                <div class="slds-tabs_default">
                    <ul class="slds-tabs_default__nav" role="tablist">
                        ${views.map(view => `
                            <li class="slds-tabs_default__item ${view.default ? 'slds-is-active' : ''}" role="presentation">
                                <a class="slds-tabs_default__link calls-view-tab" href="#" role="tab" data-view="${view.id}">
                                    ${view.label}
                                </a>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>

            <div class="filters-section">
                <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                    <h3 class="slds-text-heading_small">Filters</h3>
                    <a href="#" id="clear-filters" class="slds-text-link">Clear all filters</a>
                </div>
                <div class="slds-grid slds-wrap slds-gutters">
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Search</label>
                        <input type="text" id="filter-search" class="slds-input" placeholder="Search contact or agent..." />
                    </div>
                    ${role !== 'agent' ? `
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-4">
                        <label class="slds-form-element__label">Department</label>
                        <select id="filter-department" class="slds-select">
                            <option value="">All Departments</option>
                            <option value="Sales">Sales</option>
                            <option value="Support">Support</option>
                            <option value="Customer Success">Customer Success</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    ` : ''}
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Date</label>
                        <input type="date" id="filter-date" class="slds-input" />
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Status</label>
                        <select id="filter-status" class="slds-select">
                            <option value="">All</option>
                            <option value="Completed">Completed</option>
                            <option value="Missed">Missed</option>
                        </select>
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Direction</label>
                        <select id="filter-direction" class="slds-select">
                            <option value="">All</option>
                            <option value="Inbound">Inbound</option>
                            <option value="Outbound">Outbound</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title" id="calls-count">Call History (${calls.length} records)</h2>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <button class="slds-button slds-button_neutral" id="export-calls">Export</button>
                    </div>
                </div>
                <div class="slds-card__body">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                        <thead>
                            <tr>
                                <th scope="col" class="sortable" data-sort="timestamp">Time <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable" data-sort="contact">Contact <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable" data-sort="direction">Direction <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable" data-sort="duration">Duration <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable" data-sort="status">Status <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable" data-sort="disposition">Disposition <span class="sort-indicator"></span></th>
                                ${role !== 'agent' ? '<th scope="col" class="sortable" data-sort="userName">User <span class="sort-indicator"></span></th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="calls-table-body">
                            ${calls.map(call => `
                                <tr>
                                    <td>${DataService.formatTimestamp(call.timestamp)}</td>
                                    <td>${call.contact}</td>
                                    <td>${call.direction}</td>
                                    <td>${DataService.formatDuration(call.duration)}</td>
                                    <td>${call.status}</td>
                                    <td>${call.disposition}</td>
                                    ${role !== 'agent' ? `<td>${call.userName}</td>` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderSmsPage(role) {
        // For demo purposes, we'll use a subset of calls data as SMS messages
        const messages = DataService.getCalls(role).slice(0, 15).map(call => ({
            ...call,
            messagePreview: 'Sample SMS message text...',
            type: call.direction === 'Inbound' ? 'Received' : 'Sent'
        }));

        // Define views based on role
        const views = role === 'agent'
            ? [
                { id: 'my-sms', label: 'My Messages', default: true },
                { id: 'all-sms', label: 'All Messages', default: false }
            ]
            : role === 'supervisor'
            ? [
                { id: 'my-sms', label: 'My Messages', default: false },
                { id: 'team-sms', label: 'My Team', default: true },
                { id: 'all-sms', label: 'All Messages', default: false }
            ]
            : [
                // Admin: no "My Messages" - admins don't typically send SMS
                { id: 'team-sms', label: 'My Team', default: true },
                { id: 'all-sms', label: 'All Messages', default: false }
            ];

        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="SMS">SMS Messages</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Selector (Predefined Views) -->
            <div class="slds-m-bottom_medium">
                <div class="slds-tabs_default">
                    <ul class="slds-tabs_default__nav" role="tablist">
                        ${views.map(view => `
                            <li class="slds-tabs_default__item ${view.default ? 'slds-is-active' : ''}" role="presentation">
                                <a class="slds-tabs_default__link sms-view-tab" href="#" role="tab" data-view="${view.id}">
                                    ${view.label}
                                </a>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>

            <div class="filters-section">
                <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                    <h3 class="slds-text-heading_small">Filters</h3>
                    <a href="#" id="clear-sms-filters" class="slds-text-link">Clear all filters</a>
                </div>
                <div class="slds-grid slds-wrap slds-gutters">
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Search</label>
                        <input type="text" id="filter-sms-search" class="slds-input" placeholder="Search contact or message..." />
                    </div>
                    ${role !== 'agent' ? `
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-4">
                        <label class="slds-form-element__label">Department</label>
                        <select id="filter-sms-department" class="slds-select">
                            <option value="">All Departments</option>
                            <option value="Sales">Sales</option>
                            <option value="Support">Support</option>
                            <option value="Customer Success">Customer Success</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    ` : ''}
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Date</label>
                        <input type="date" id="filter-sms-date" class="slds-input" />
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-${role === 'agent' ? '3' : '4'}">
                        <label class="slds-form-element__label">Type</label>
                        <select id="filter-sms-type" class="slds-select">
                            <option value="">All</option>
                            <option value="Sent">Sent</option>
                            <option value="Received">Received</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title" id="sms-count">Message History (${messages.length} records)</h2>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <button class="slds-button slds-button_neutral" id="export-sms">Export</button>
                    </div>
                </div>
                <div class="slds-card__body">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                        <thead>
                            <tr>
                                <th scope="col" class="sortable-sms" data-sort="timestamp">Time <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable-sms" data-sort="contact">Contact <span class="sort-indicator"></span></th>
                                <th scope="col" class="sortable-sms" data-sort="type">Type <span class="sort-indicator"></span></th>
                                <th scope="col">Message Preview</th>
                                ${role !== 'agent' ? '<th scope="col" class="sortable-sms" data-sort="userName">User <span class="sort-indicator"></span></th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="sms-table-body">
                            ${messages.map(msg => `
                                <tr>
                                    <td>${DataService.formatTimestamp(msg.timestamp)}</td>
                                    <td>${msg.contact}</td>
                                    <td>${msg.type}</td>
                                    <td>${msg.messagePreview}</td>
                                    ${role !== 'agent' ? `<td>${msg.userName}</td>` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderPowerdialerPage(role) {
        const lists = DataService.getLists(role);

        if (role === 'agent') {
            const session = AppState.getDialerSession();
            const queue = DataService.getPowerdialerQueue(null, 10);
            const hasActiveSession = session.status === 'active' || session.status === 'paused';
            const activeList = lists.find(l => l.id === session.listId);

            // Empty state
            if (lists.length === 0) {
                return `
                    <div class="slds-page-header">
                        <div class="slds-page-header__row">
                            <div class="slds-page-header__col-title">
                                <div class="slds-media">
                                    <div class="slds-media__body">
                                        <h1 class="slds-page-header__title slds-truncate" title="Powerdialer">Powerdialer</h1>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="slds-illustration slds-illustration_small" style="margin-top: 4rem;">
                        <div class="slds-text-align_center">
                            <h3 class="slds-text-heading_medium slds-m-bottom_small">No Lists Assigned</h3>
                            <p class="slds-text-body_regular slds-text-color_weak">Contact your supervisor to get assigned to powerdialer lists.</p>
                        </div>
                    </div>
                `;
            }

            const currentContact = hasActiveSession ? queue[session.contactIndex] : null;
            const upNextContacts = hasActiveSession ? queue.slice(session.contactIndex + 1, session.contactIndex + 4) : [];
            const progress = hasActiveSession ? Math.round((session.contactIndex / queue.length) * 100) : 0;
            const isPaused = session.status === 'paused';

            // Single page with active session at top, lists below
            return `
                <div class="slds-page-header">
                    <div class="slds-page-header__row">
                        <div class="slds-page-header__col-title">
                            <div class="slds-media">
                                <div class="slds-media__body">
                                    <h1 class="slds-page-header__title slds-truncate" title="Powerdialer">Powerdialer</h1>
                                    <p class="slds-page-header__meta-text">
                                        ${hasActiveSession
                                            ? `Active Session: ${activeList.name} • Contact ${session.contactIndex + 1} of ${queue.length} (${progress}%)`
                                            : `${lists.length} assigned list${lists.length > 1 ? 's' : ''}`
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>
                        ${hasActiveSession ? `
                            <div class="slds-page-header__col-actions">
                                <div class="slds-page-header__controls">
                                    ${isPaused ? `
                                        <button class="slds-button slds-button_brand" onclick="DialpadApp.resumeSession()">
                                            Resume Session
                                        </button>
                                    ` : `
                                        <button class="slds-button slds-button_neutral" onclick="DialpadApp.pauseSession()">
                                            Pause Session
                                        </button>
                                    `}
                                    <button class="slds-button slds-button_neutral" onclick="DialpadApp.endSession()">
                                        End Session
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                ${hasActiveSession && isPaused ? `
                    <div class="slds-notify slds-notify_alert slds-theme_warning" style="margin-top: 1rem;">
                        <span class="slds-assistive-text">warning</span>
                        <h2>Session Paused</h2>
                    </div>
                ` : ''}

                ${hasActiveSession && currentContact ? `
                    <div class="slds-grid slds-wrap slds-gutters" style="margin-top: 1rem;">
                        <div class="slds-col slds-size_1-of-2">
                            <div class="slds-card" style="border-left: 4px solid #0176d3;">
                                <div class="slds-card__header slds-grid">
                                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                        <div class="slds-media__body">
                                            <h2 class="slds-card__header-title">Current Contact</h2>
                                        </div>
                                    </header>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    <div class="slds-media">
                                        <div class="slds-media__body">
                                            <h3 class="slds-text-heading_small slds-m-bottom_xxx-small">${currentContact.name}</h3>
                                            <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">${currentContact.company}</p>
                                            <dl class="slds-dl_horizontal">
                                                <dt class="slds-dl_horizontal__label">
                                                    <p class="slds-text-body_small slds-text-color_weak">Phone:</p>
                                                </dt>
                                                <dd class="slds-dl_horizontal__detail">
                                                    <p class="slds-text-body_small"><strong>${currentContact.phone}</strong></p>
                                                </dd>
                                                <dt class="slds-dl_horizontal__label">
                                                    <p class="slds-text-body_small slds-text-color_weak">Priority:</p>
                                                </dt>
                                                <dd class="slds-dl_horizontal__detail">
                                                    <span class="slds-badge ${currentContact.priority === 'High' ? 'slds-theme_error' : currentContact.priority === 'Medium' ? 'slds-theme_warning' : ''}">${currentContact.priority}</span>
                                                </dd>
                                                <dt class="slds-dl_horizontal__label">
                                                    <p class="slds-text-body_small slds-text-color_weak">Last Activity:</p>
                                                </dt>
                                                <dd class="slds-dl_horizontal__detail">
                                                    <p class="slds-text-body_small">${currentContact.lastActivity}</p>
                                                </dd>
                                            </dl>
                                            <div class="slds-grid slds-grid_align-spread slds-m-top_medium" style="gap: 0.5rem;">
                                                <button class="slds-button slds-button_brand slds-col" onclick="DialpadApp.callNow()" ${isPaused ? 'disabled' : ''}>
                                                    Call Now
                                                </button>
                                                <button class="slds-button slds-button_neutral slds-col" onclick="DialpadApp.skipContact()">
                                                    Skip
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="slds-col slds-size_1-of-2">
                            <div class="slds-card">
                                <div class="slds-card__header">
                                    <header class="slds-media slds-media_center">
                                        <div class="slds-media__body">
                                            <h2 class="slds-card__header-title">Up Next</h2>
                                        </div>
                                    </header>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    ${upNextContacts.length > 0 ? `
                                        <ul class="slds-has-dividers_bottom-space">
                                            ${upNextContacts.map((contact, index) => `
                                                <li class="slds-item slds-p-vertical_xx-small">
                                                    <div class="slds-grid slds-grid_vertical-align-start">
                                                        <div class="slds-col slds-no-flex slds-m-right_small">
                                                            <span class="slds-badge">${session.contactIndex + index + 2}</span>
                                                        </div>
                                                        <div class="slds-col">
                                                            <p class="slds-text-body_small"><strong>${contact.name}</strong></p>
                                                            <p class="slds-text-body_small slds-text-color_weak">${contact.company} • ${contact.phone}</p>
                                                        </div>
                                                    </div>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : '<p class="slds-text-align_center slds-text-color_weak">No more contacts in queue</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div class="slds-card" style="margin-top: 1rem;">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">My Assigned Lists</h2>
                                <p class="slds-text-body_small slds-text-color_weak slds-m-top_xxx-small">
                                    ${hasActiveSession ? 'Other lists' : 'Select a list to start calling'}
                                </p>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                            <thead>
                                <tr>
                                    ${hasActiveSession ? '<th scope="col">Status</th>' : ''}
                                    <th scope="col">List Name</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Called</th>
                                    <th scope="col">Remaining</th>
                                    <th scope="col">Progress</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lists.map(list => {
                                    const contacted = list.completedContacts || list.contacted || 0;
                                    const percent = Math.round((contacted / list.totalContacts) * 100);
                                    const remaining = list.totalContacts - contacted;
                                    const isActive = hasActiveSession && list.id === session.listId;

                                    return `
                                        <tr ${isActive ? 'style="background-color: #f3f2f2;"' : ''}>
                                            ${hasActiveSession ? `
                                                <td>
                                                    ${isActive
                                                        ? '<span class="slds-badge slds-theme_success">Active</span>'
                                                        : '<span class="slds-text-color_weak">—</span>'}
                                                </td>
                                            ` : ''}
                                            <td><strong>${list.name}</strong></td>
                                            <td>${list.totalContacts}</td>
                                            <td>${contacted}</td>
                                            <td>${remaining}</td>
                                            <td>
                                                <div class="slds-grid slds-grid_vertical-align-center">
                                                    <span class="slds-m-right_x-small">${percent}%</span>
                                                    <div class="slds-progress-bar slds-progress-bar_x-small" style="width: 80px;">
                                                        <span class="slds-progress-bar__value" style="width: ${percent}%;"></span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                ${hasActiveSession
                                                    ? (isActive
                                                        ? '<button class="slds-button slds-button_neutral" disabled>Currently Active</button>'
                                                        : '<button class="slds-button slds-button_neutral" disabled title="End current session first">Start Calling</button>')
                                                    : `<button class="slds-button slds-button_brand" onclick="DialpadApp.startCalling('${list.id}')">Start Calling</button>`
                                                }
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        } else {
            // Supervisor/Admin view
            return `
                <div class="slds-page-header">
                    <div class="slds-page-header__row">
                        <div class="slds-page-header__col-title">
                            <div class="slds-media">
                                <div class="slds-media__body">
                                    <h1 class="slds-page-header__title slds-truncate" title="Powerdialer">Powerdialer</h1>
                                </div>
                            </div>
                        </div>
                        <div class="slds-page-header__col-actions">
                            <div class="slds-page-header__controls">
                                <div class="slds-page-header__control">
                                    <button class="slds-button slds-button_brand">Create List</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="slds-card">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Manage Lists</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body">
                        <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                            <thead>
                                <tr>
                                    <th scope="col">List Name</th>
                                    <th scope="col">Total Contacts</th>
                                    <th scope="col">Completed</th>
                                    <th scope="col">Assigned Agents</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lists.map(list => {
                                    const progress = Math.round((list.completedContacts / list.totalContacts) * 100);
                                    return `
                                        <tr>
                                            <td>${list.name}</td>
                                            <td>${list.totalContacts}</td>
                                            <td>${list.completedContacts} (${progress}%)</td>
                                            <td>${list.assignedAgents.length}</td>
                                            <td><span class="slds-badge">${list.status}</span></td>
                                            <td>
                                                <button class="slds-button slds-button_neutral">Edit</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    },

    renderSettingsPage(role) {
        if (role !== 'admin') {
            return `
                <div class="slds-page-header">
                    <div class="slds-page-header__row">
                        <div class="slds-page-header__col-title">
                            <div class="slds-media">
                                <div class="slds-media__body">
                                    <h1 class="slds-page-header__title slds-truncate" title="Settings">Settings</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="slds-card">
                    <div class="slds-card__body slds-card__body_inner">
                        <p>Settings are only accessible to administrators.</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="Settings">Settings</h1>
                                <p class="slds-page-header__meta-text">Configure Dialpad for Salesforce integration</p>
                            </div>
                        </div>
                    </div>
                    <div class="slds-page-header__col-actions">
                        <div class="slds-page-header__controls">
                            <button class="slds-button slds-button_neutral" id="cancel-settings">Cancel Changes</button>
                            <button class="slds-button slds-button_brand" id="save-settings">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integration Status Section (Always Visible) -->
            <div class="slds-card slds-m-bottom_medium">
                <div class="slds-card__header slds-grid slds-grid_align-spread">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Integration Status</h2>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <button class="slds-button slds-button_neutral" id="test-connection">Test Connection</button>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-wrap slds-gutters">
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">Connection Status</label>
                                <div class="slds-form-element__control">
                                    <span class="slds-badge status-connected">Connected</span>
                                </div>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">Last Sync</label>
                                <div class="slds-form-element__control">
                                    <p>Nov 18, 2025 4:15 PM</p>
                                </div>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">Package Version</label>
                                <div class="slds-form-element__control">
                                    <p>1.820</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="slds-m-top_small">
                        <a href="#" id="view-integration-logs">View integration logs</a>
                    </div>
                </div>
            </div>

            <!-- Accordion Sections -->
            <div class="slds-accordion">

                <!-- Call & SMS Logging -->
                <section class="slds-accordion__section slds-is-open">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="logging">
                                <span class="slds-accordion__summary-content">Call & SMS Logging</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="logging-content">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <div class="slds-form-element">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Auto-log calls</span>
                                        <input type="checkbox" id="auto-log-calls" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Automatically create Salesforce tasks for all calls</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Auto-log SMS</span>
                                        <input type="checkbox" id="auto-log-sms" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Automatically create Salesforce tasks for all SMS messages</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label">Call types to log</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-checkbox">
                                            <input type="checkbox" id="log-inbound" checked />
                                            <label class="slds-checkbox__label" for="log-inbound">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Inbound calls</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="log-outbound" checked />
                                            <label class="slds-checkbox__label" for="log-outbound">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Outbound calls</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="log-missed" checked />
                                            <label class="slds-checkbox__label" for="log-missed">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Missed calls</span>
                                            </label>
                                        </span>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="default-task-status">Default task status</label>
                                    <div class="slds-form-element__control">
                                        <select id="default-task-status" class="slds-select">
                                            <option value="in-progress">In Progress</option>
                                            <option value="completed" selected>Completed</option>
                                            <option value="not-logged">Not Logged</option>
                                        </select>
                                    </div>
                                    <div class="slds-form-element__help">Status applied to logged calls and SMS</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="disposition-values">Disposition values</label>
                                    <div class="slds-form-element__control">
                                        <textarea id="disposition-values" class="slds-textarea" rows="3" placeholder="Connected, No Answer, Voicemail, Callback, Interested, Not Interested">Connected, No Answer, Voicemail, Callback, Interested, Not Interested</textarea>
                                    </div>
                                    <div class="slds-form-element__help">Comma-separated list of call disposition options</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- User Management -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="users">
                                <span class="slds-accordion__summary-content">User Management</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="users-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="default-user">Default user for unmatched calls</label>
                                    <div class="slds-form-element__control">
                                        <select id="default-user" class="slds-select">
                                            <option value="">-- Select User --</option>
                                            <option value="admin" selected>System Admin</option>
                                            <option value="manager">Sales Manager</option>
                                        </select>
                                    </div>
                                    <div class="slds-form-element__help">Assign calls that don't match any Dialpad user</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label">Connected users (15 of 25)</label>
                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-m-top_x-small">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th scope="col"><div class="slds-truncate">Salesforce User</div></th>
                                                <th scope="col"><div class="slds-truncate">Dialpad Email</div></th>
                                                <th scope="col"><div class="slds-truncate">Status</div></th>
                                                <th scope="col"><div class="slds-truncate">Actions</div></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Sarah Johnson</td>
                                                <td>sarah.johnson@company.com</td>
                                                <td><span class="slds-badge slds-theme_success">Connected</span></td>
                                                <td><button class="slds-button slds-button_destructive slds-button_small">Remove</button></td>
                                            </tr>
                                            <tr>
                                                <td>Mike Chen</td>
                                                <td>mike.chen@company.com</td>
                                                <td><span class="slds-badge slds-theme_success">Connected</span></td>
                                                <td><button class="slds-button slds-button_destructive slds-button_small">Remove</button></td>
                                            </tr>
                                            <tr>
                                                <td>Emily Rodriguez</td>
                                                <td>emily.r@company.com</td>
                                                <td><span class="slds-badge slds-theme_warning">Pending</span></td>
                                                <td><button class="slds-button slds-button_neutral slds-button_small">Resend Invite</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="slds-m-top_small">
                                        <button class="slds-button slds-button_neutral" id="add-users-btn">Add Users</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Click to Call & Screen Pop -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="cti">
                                <span class="slds-accordion__summary-content">Click to Call & Screen Pop</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="cti-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">Click to Call Settings</h3>

                                <div class="slds-form-element">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Confirm phone number before placing call</span>
                                        <input type="checkbox" id="confirm-before-call" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Show confirmation dialog before placing outbound calls</div>
                                </div>

                                <h3 class="slds-text-heading_small slds-m-top_large slds-m-bottom_small">Screen Pop Settings</h3>

                                <div class="slds-form-element">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Pop contact on incoming call</span>
                                        <input type="checkbox" id="pop-contact" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Automatically pop Contact record when call comes in</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Pop case if open</span>
                                        <input type="checkbox" id="pop-case" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Pop open Case if contact has one</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Auto-create contact for unknown numbers</span>
                                        <input type="checkbox" id="auto-create-contact" />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Create new Contact when phone number doesn't match</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label">Object search priority (when multiple records match)</label>
                                    <div class="slds-form-element__control">
                                        <div class="slds-m-bottom_x-small">1. Contact</div>
                                        <div class="slds-m-bottom_x-small">2. Lead</div>
                                        <div class="slds-m-bottom_x-small">3. Account</div>
                                        <div class="slds-m-bottom_x-small">4. Opportunity</div>
                                        <div class="slds-m-bottom_x-small">5. Case</div>
                                    </div>
                                    <div class="slds-form-element__help">Screen pop will follow this priority order</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Search custom objects</span>
                                        <input type="checkbox" id="search-custom-objects" />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Include custom objects in phone number search</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Powerdialer Settings -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="powerdialer">
                                <span class="slds-accordion__summary-content">Powerdialer Settings</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="powerdialer-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">General Settings</h3>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="dialing-mode">Dialing mode</label>
                                    <div class="slds-form-element__control">
                                        <select id="dialing-mode" class="slds-select">
                                            <option value="preview">Preview (Agent reviews before dialing)</option>
                                            <option value="progressive" selected>Progressive (Auto-dial with agent pacing)</option>
                                            <option value="power">Power (Multiple calls per agent)</option>
                                        </select>
                                    </div>
                                    <div class="slds-form-element__help">How powerdialer places calls from lists</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="calls-per-agent">Calls per agent ratio</label>
                                    <div class="slds-form-element__control">
                                        <input type="number" id="calls-per-agent" class="slds-input" value="1.5" min="1" max="3" step="0.1" />
                                    </div>
                                    <div class="slds-form-element__help">Simultaneous calls per available agent (Power mode only)</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Enable call recording</span>
                                        <input type="checkbox" id="powerdialer-recording" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Automatically record all powerdialer calls</div>
                                </div>

                                <h3 class="slds-text-heading_small slds-m-top_large slds-m-bottom_small">List Segmentation</h3>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Segment lists by</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-checkbox">
                                            <input type="checkbox" id="segment-territory" checked />
                                            <label class="slds-checkbox__label" for="segment-territory">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Territory</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="segment-priority" checked />
                                            <label class="slds-checkbox__label" for="segment-priority">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Lead Priority</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="segment-timezone" />
                                            <label class="slds-checkbox__label" for="segment-timezone">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Timezone</span>
                                            </label>
                                        </span>
                                    </div>
                                    <div class="slds-form-element__help">Automatically segment lists based on these criteria</div>
                                </div>

                                <h3 class="slds-text-heading_small slds-m-top_large slds-m-bottom_small">Exclusion Rules</h3>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Exclude from powerdialer lists</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-checkbox">
                                            <input type="checkbox" id="exclude-dnc" checked />
                                            <label class="slds-checkbox__label" for="exclude-dnc">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Do Not Call (DNC) contacts</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-top_x-small">
                                            <input type="checkbox" id="exclude-unsubscribed" checked />
                                            <label class="slds-checkbox__label" for="exclude-unsubscribed">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Email unsubscribed contacts</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-top_x-small">
                                            <input type="checkbox" id="exclude-closed-opps" />
                                            <label class="slds-checkbox__label" for="exclude-closed-opps">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Contacts with closed opportunities</span>
                                            </label>
                                        </span>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="exclusion-statuses">Excluded lead statuses</label>
                                    <div class="slds-form-element__control">
                                        <textarea id="exclusion-statuses" class="slds-textarea" rows="2" placeholder="Unqualified, Closed - Lost, Duplicate">Unqualified, Closed - Lost, Duplicate</textarea>
                                    </div>
                                    <div class="slds-form-element__help">Comma-separated list of lead statuses to exclude</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CTI Record Selection -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="record-selection">
                                <span class="slds-accordion__summary-content">CTI Record Selection</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="record-selection-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">Case Selection Criteria</h3>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="case-priority">When one case matches, pop if priority is</label>
                                    <div class="slds-form-element__control">
                                        <select id="case-priority" class="slds-select">
                                            <option value="any" selected>Any Priority</option>
                                            <option value="high">High or Critical</option>
                                            <option value="critical">Critical Only</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="case-status">And status is</label>
                                    <div class="slds-form-element__control">
                                        <select id="case-status" class="slds-select">
                                            <option value="any">Any Status</option>
                                            <option value="open" selected>Open Cases Only</option>
                                            <option value="escalated">Escalated Only</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label">When multiple cases match, show list view with</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-checkbox">
                                            <input type="checkbox" id="case-list-number" checked />
                                            <label class="slds-checkbox__label" for="case-list-number">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Case Number</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="case-list-subject" checked />
                                            <label class="slds-checkbox__label" for="case-list-subject">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Subject</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="case-list-status" checked />
                                            <label class="slds-checkbox__label" for="case-list-status">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Status</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="case-list-priority" checked />
                                            <label class="slds-checkbox__label" for="case-list-priority">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Priority</span>
                                            </label>
                                        </span>
                                    </div>
                                </div>

                                <h3 class="slds-text-heading_small slds-m-top_large slds-m-bottom_small">Opportunity Selection Criteria</h3>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">When multiple opportunities match, show list view with</label>
                                    <div class="slds-form-element__control">
                                        <span class="slds-checkbox">
                                            <input type="checkbox" id="opp-list-name" checked />
                                            <label class="slds-checkbox__label" for="opp-list-name">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Opportunity Name</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="opp-list-stage" checked />
                                            <label class="slds-checkbox__label" for="opp-list-stage">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Stage</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="opp-list-amount" checked />
                                            <label class="slds-checkbox__label" for="opp-list-amount">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Amount</span>
                                            </label>
                                        </span>
                                        <span class="slds-checkbox slds-m-left_medium">
                                            <input type="checkbox" id="opp-list-closedate" checked />
                                            <label class="slds-checkbox__label" for="opp-list-closedate">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label">Close Date</span>
                                            </label>
                                        </span>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="opp-exclude-stages">Exclude opportunities in these stages</label>
                                    <div class="slds-form-element__control">
                                        <textarea id="opp-exclude-stages" class="slds-textarea" rows="2" placeholder="Closed Won, Closed Lost">Closed Won, Closed Lost</textarea>
                                    </div>
                                    <div class="slds-form-element__help">Comma-separated list of stages to exclude from list view</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Field Mapping -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="field-mapping">
                                <span class="slds-accordion__summary-content">Field Mapping</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="field-mapping-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">Call Activity Mapping</h3>
                                <p class="slds-m-bottom_medium">Map Dialpad call data to Salesforce Task fields</p>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="map-call-duration">Call Duration maps to</label>
                                    <div class="slds-form-element__control">
                                        <select id="map-call-duration" class="slds-select">
                                            <option value="CallDurationInSeconds" selected>CallDurationInSeconds</option>
                                            <option value="custom-duration">Custom_Call_Duration__c</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="map-call-recording">Recording URL maps to</label>
                                    <div class="slds-form-element__control">
                                        <select id="map-call-recording" class="slds-select">
                                            <option value="Description">Description (appended)</option>
                                            <option value="custom-recording" selected>Custom_Recording_URL__c</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="map-call-disposition">Call Disposition maps to</label>
                                    <div class="slds-form-element__control">
                                        <select id="map-call-disposition" class="slds-select">
                                            <option value="CallDisposition" selected>CallDisposition</option>
                                            <option value="Subject">Subject (prefixed)</option>
                                            <option value="custom-disposition">Custom_Disposition__c</option>
                                        </select>
                                    </div>
                                </div>

                                <h3 class="slds-text-heading_small slds-m-top_large slds-m-bottom_small">SMS Activity Mapping</h3>
                                <p class="slds-m-bottom_medium">Map Dialpad SMS data to Salesforce Task fields</p>

                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="map-sms-body">SMS Body maps to</label>
                                    <div class="slds-form-element__control">
                                        <select id="map-sms-body" class="slds-select">
                                            <option value="Description" selected>Description</option>
                                            <option value="custom-sms-body">Custom_SMS_Body__c</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="map-sms-direction">SMS Direction maps to</label>
                                    <div class="slds-form-element__control">
                                        <select id="map-sms-direction" class="slds-select">
                                            <option value="Subject">Subject (Inbound/Outbound prefix)</option>
                                            <option value="custom-direction" selected>Custom_SMS_Direction__c</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="map-sms-status">SMS Status maps to</label>
                                    <div class="slds-form-element__control">
                                        <select id="map-sms-status" class="slds-select">
                                            <option value="Status" selected>Status</option>
                                            <option value="custom-status">Custom_SMS_Status__c</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Number Configuration -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="numbers">
                                <span class="slds-accordion__summary-content">Number Configuration</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="numbers-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Dialpad phone numbers</label>
                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-m-top_x-small">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th scope="col"><div class="slds-truncate">Phone Number</div></th>
                                                <th scope="col"><div class="slds-truncate">Type</div></th>
                                                <th scope="col"><div class="slds-truncate">Assigned To</div></th>
                                                <th scope="col"><div class="slds-truncate">Sync Status</div></th>
                                                <th scope="col"><div class="slds-truncate">Actions</div></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>+1 (555) 123-4567</td>
                                                <td>Main Line</td>
                                                <td>Company</td>
                                                <td><span class="slds-badge slds-theme_success">Enabled</span></td>
                                                <td><button class="slds-button slds-button_neutral slds-button_small" id="disable-number-1">Disable</button></td>
                                            </tr>
                                            <tr>
                                                <td>+1 (555) 234-5678</td>
                                                <td>Direct</td>
                                                <td>Sales Team</td>
                                                <td><span class="slds-badge slds-theme_success">Enabled</span></td>
                                                <td><button class="slds-button slds-button_neutral slds-button_small" id="disable-number-2">Disable</button></td>
                                            </tr>
                                            <tr>
                                                <td>+1 (555) 345-6789</td>
                                                <td>Support</td>
                                                <td>Support Team</td>
                                                <td><span class="slds-badge slds-theme_error">Disabled</span></td>
                                                <td><button class="slds-button slds-button_brand slds-button_small" id="enable-number-3">Enable</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="slds-form-element__help">Manage which Dialpad numbers sync data to Salesforce</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quota Configuration -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="quota">
                                <span class="slds-accordion__summary-content">Quota Configuration</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="quota-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="daily-quota">Daily call target (per agent)</label>
                                    <div class="slds-form-element__control">
                                        <input type="number" id="daily-quota" class="slds-input" value="${AppState.companyQuota.dailyCallTarget}" min="0" max="500" />
                                    </div>
                                    <div class="slds-form-element__help">Default daily call target for all agents</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="weekly-quota">Weekly call target (per agent)</label>
                                    <div class="slds-form-element__control">
                                        <input type="number" id="weekly-quota" class="slds-input" value="${AppState.companyQuota.weeklyCallTarget}" min="0" max="2000" />
                                    </div>
                                    <div class="slds-form-element__help">Default weekly call target for all agents</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Enable quota tracking</span>
                                        <input type="checkbox" id="quota-tracking-enabled" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Enabled</span>
                                            <span class="slds-checkbox_off">Disabled</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Show quota progress on agent dashboards</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Display quota on dashboard</span>
                                        <input type="checkbox" id="quota-display-enabled" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Shown</span>
                                            <span class="slds-checkbox_off">Hidden</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Show quota widget on agent home page</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sandbox Management -->
                <section class="slds-accordion__section">
                    <div class="slds-accordion__summary">
                        <h2 class="slds-accordion__summary-heading">
                            <button class="slds-button slds-button_reset slds-accordion__summary-action" type="button" data-accordion="sandbox">
                                <span class="slds-accordion__summary-content">Sandbox Management</span>
                            </button>
                        </h2>
                    </div>
                    <div class="slds-accordion__content" id="sandbox-content" style="display: none;">
                        <div class="slds-p-around_medium">
                            <div class="slds-form slds-form_stacked">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label" for="sandbox-last-update">Last sandbox update</label>
                                    <div class="slds-form-element__control">
                                        <input type="text" id="sandbox-last-update" class="slds-input" value="2024-01-15" readonly />
                                    </div>
                                    <div class="slds-form-element__help">When the sandbox was last refreshed with production changes</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-form-element__label" for="sandbox-reminder">Reminder frequency</label>
                                    <div class="slds-form-element__control">
                                        <select id="sandbox-reminder" class="slds-select">
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                        </select>
                                    </div>
                                    <div class="slds-form-element__help">How often to remind admins to update sandbox</div>
                                </div>

                                <div class="slds-form-element slds-m-top_medium">
                                    <label class="slds-checkbox_toggle slds-grid">
                                        <span class="slds-form-element__label slds-m-bottom_none">Test in sandbox before production</span>
                                        <input type="checkbox" id="require-sandbox-testing" checked />
                                        <span class="slds-checkbox_faux_container">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-checkbox_on">Required</span>
                                            <span class="slds-checkbox_off">Optional</span>
                                        </span>
                                    </label>
                                    <div class="slds-form-element__help">Show warning when deploying updates without sandbox testing</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        `;
    },

    renderHomeCharts(role) {
        // Destroy existing charts first
        ChartsService.destroyAll();

        // Wait for DOM to be ready, then render charts
        setTimeout(() => {
            const calls = DataService.getCalls(role);
            const users = DataService.getUsers(role);

            if (role === 'admin') {
                // Admin dashboard has no charts - simplified Mission Control view
                // Attach admin dashboard widget listeners
                this.attachAdminDashboardWidgetListeners();
            } else if (role === 'supervisor') {
                // New supervisor dashboard charts
                const metrics = DataService.getSupervisorMetrics();

                // Handled Calls donut chart
                const handledCallsCtx = document.getElementById('supervisor-handled-calls-chart');
                if (handledCallsCtx) {
                    new Chart(handledCallsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Inbound', 'Outbound', 'Connected callbacks'],
                            datasets: [{
                                data: [metrics.handledCalls.inbound, metrics.handledCalls.outbound, metrics.handledCalls.callbacks],
                                backgroundColor: ['#6B46C1', '#C4699F', '#F9A03F'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            cutout: '70%'
                        }
                    });
                }

                // AI Scorecards line chart
                const aiScorecardCtx = document.getElementById('supervisor-ai-scorecard-chart');
                if (aiScorecardCtx) {
                    const hours = ['4 am', '8 am', '12 pm', '4 pm', '8 pm'];
                    new Chart(aiScorecardCtx, {
                        type: 'line',
                        data: {
                            labels: hours,
                            datasets: [
                                {
                                    label: 'Average score',
                                    data: [85, 86, 87, 88, 88],
                                    borderColor: '#3A49DA',
                                    backgroundColor: 'rgba(58, 73, 218, 0.1)',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: 'Previous day',
                                    data: [84, 85, 86, 87, 86],
                                    borderColor: '#C4C4C4',
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: 'Top CC',
                                    data: [88, 89, 90, 91, 90],
                                    borderColor: '#F9A03F',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: 'Bottom CC',
                                    data: [80, 81, 82, 83, 82],
                                    borderColor: '#C23934',
                                    fill: false,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: { usePointStyle: true, padding: 15 }
                                }
                            },
                            scales: {
                                y: { beginAtZero: false, min: 75, max: 100 }
                            }
                        }
                    });
                }

                // AI Agent donut chart
                const aiAgentCtx = document.getElementById('supervisor-ai-agent-chart');
                if (aiAgentCtx) {
                    new Chart(aiAgentCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Automated', 'Not automated'],
                            datasets: [{
                                data: [metrics.aiAgent.automated, metrics.aiAgent.notAutomated],
                                backgroundColor: ['#6B46C1', '#C4699F'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            cutout: '70%'
                        }
                    });
                }

                // AI CSAT trend line chart
                const aiCsatCtx = document.getElementById('supervisor-ai-csat-chart');
                if (aiCsatCtx) {
                    ChartsService.createAICsatTrendChart('supervisor-ai-csat-chart', metrics.aiCsat.trend.data);
                }
            } else {
                // Agent dashboard - no charts (using placeholders)
            }
        }, 100);
    },

    attachAdminDashboardWidgetListeners() {
        // View Changelog button in Package Update widget
        const changelogWidgetBtn = document.getElementById('view-changelog-widget');
        if (changelogWidgetBtn) {
            changelogWidgetBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showChangelogModal();
            });
        }
    },

    renderReportsPage(role) {
        const reports = this.getReportsForRole(role);
        const categories = ['All', 'Call Activity', 'Performance', 'Organization', 'Quality', 'Powerdialer'];

        return `
            <div class="slds-page-header">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-media">
                            <div class="slds-media__body">
                                <h1 class="slds-page-header__title slds-truncate" title="Reports Library">Reports Library</h1>
                                <p class="slds-page-header__meta-text">${reports.length} reports available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slds-m-bottom_medium">
                <div class="slds-form-element">
                    <div class="slds-form-element__control">
                        <input type="text" id="reports-search" class="slds-input" placeholder="Search reports..." />
                    </div>
                </div>
            </div>

            <div class="slds-tabs_default slds-m-bottom_medium">
                <ul class="slds-tabs_default__nav" role="tablist">
                    ${categories.map((category, index) => `
                        <li class="slds-tabs_default__item ${index === 0 ? 'slds-is-active' : ''}" role="presentation">
                            <a class="slds-tabs_default__link" href="#" role="tab" data-category="${category}" id="tab-${category.toLowerCase().replace(/\s+/g, '-')}">
                                ${category}
                            </a>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <div id="reports-container" class="slds-grid slds-wrap slds-gutters">
                ${reports.map(report => `
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-m-bottom_medium" data-report-name="${report.name.toLowerCase()}" data-report-category="${report.category}">
                        <div class="slds-card">
                            <div class="slds-card__header slds-grid">
                                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                    <div class="slds-media__body">
                                        <h2 class="slds-card__header-title">${report.name}</h2>
                                    </div>
                                </header>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <p class="slds-m-bottom_small">${report.description}</p>
                                <p class="slds-text-color_weak slds-m-bottom_x-small">
                                    <small>Category: ${report.category}</small>
                                </p>
                                <p class="slds-text-color_weak slds-m-bottom_medium">
                                    <small>Last run: ${this.getRandomLastRunDate()}</small>
                                </p>
                                <div class="slds-grid slds-grid_align-spread">
                                    <button class="slds-button slds-button_brand report-run-btn" data-report-name="${report.name}">Run Report</button>
                                    <button class="slds-button slds-button_neutral report-customize-btn" data-report-name="${report.name}">Customize</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    },

    getRandomLastRunDate() {
        const dates = [
            'Nov 17, 2:30 PM',
            'Nov 17, 10:45 AM',
            'Nov 16, 4:15 PM',
            'Nov 15, 9:20 AM',
            'Never run'
        ];
        return dates[Math.floor(Math.random() * dates.length)];
    },

    getReportsForRole(role) {
        const allReports = [
            // Call Activity Reports
            { name: 'Call Volume by Time', category: 'Call Activity', description: 'Analyze call patterns throughout the day', roles: ['admin', 'supervisor', 'agent'] },
            { name: 'Call Duration Analysis', category: 'Call Activity', description: 'Average and total call duration metrics', roles: ['admin', 'supervisor', 'agent'] },
            { name: 'Missed Calls Report', category: 'Call Activity', description: 'Track and analyze missed call trends', roles: ['admin', 'supervisor'] },
            { name: 'Call Disposition Summary', category: 'Call Activity', description: 'Breakdown of call outcomes and dispositions', roles: ['admin', 'supervisor', 'agent'] },
            { name: 'Inbound vs Outbound', category: 'Call Activity', description: 'Compare inbound and outbound call metrics', roles: ['admin', 'supervisor'] },
            { name: 'Peak Hours Analysis', category: 'Call Activity', description: 'Identify busiest calling hours', roles: ['admin', 'supervisor'] },

            // Agent Performance Reports
            { name: 'Agent Performance Dashboard', category: 'Performance', description: 'Comprehensive agent metrics overview', roles: ['admin', 'supervisor'] },
            { name: 'Agent Productivity Report', category: 'Performance', description: 'Calls per hour and efficiency metrics', roles: ['admin', 'supervisor'] },
            { name: 'Agent State Timeline', category: 'Performance', description: 'Time spent in each agent state', roles: ['admin', 'supervisor'] },
            { name: 'Personal Performance', category: 'Performance', description: 'Your individual call statistics', roles: ['agent'] },
            { name: 'Agent Leaderboard', category: 'Performance', description: 'Top performing agents by metrics', roles: ['admin', 'supervisor'] },
            { name: 'Call Handling Time', category: 'Performance', description: 'Average handle time per agent', roles: ['admin', 'supervisor'] },

            // Department & Office Reports
            { name: 'Department Comparison', category: 'Organization', description: 'Compare metrics across departments', roles: ['admin'] },
            { name: 'Office Performance', category: 'Organization', description: 'Call metrics by office location', roles: ['admin'] },
            { name: 'Team Performance', category: 'Organization', description: 'Your team metrics and trends', roles: ['supervisor'] },

            // Quality & Compliance
            { name: 'SLA Compliance Report', category: 'Quality', description: 'Service level agreement adherence', roles: ['admin', 'supervisor'] },
            { name: 'First Call Resolution', category: 'Quality', description: 'Rate of issues resolved on first call', roles: ['admin', 'supervisor'] },
            { name: 'Call Quality Score', category: 'Quality', description: 'Quality metrics and ratings', roles: ['admin', 'supervisor'] },

            // Powerdialer Reports
            { name: 'Powerdialer List Progress', category: 'Powerdialer', description: 'Track completion of calling lists', roles: ['admin', 'supervisor', 'agent'] },
            { name: 'List Performance Comparison', category: 'Powerdialer', description: 'Compare success rates across lists', roles: ['admin', 'supervisor'] },
            { name: 'Contact Disposition by List', category: 'Powerdialer', description: 'Outcomes for each calling list', roles: ['admin', 'supervisor'] }
        ];

        return allReports.filter(report => report.roles.includes(role));
    },

    attachReportsPageListeners() {
        const searchInput = document.getElementById('reports-search');
        const categoryTabs = document.querySelectorAll('[data-category]');
        const reportCards = document.querySelectorAll('[data-report-name]');
        const runButtons = document.querySelectorAll('.report-run-btn');
        const customizeButtons = document.querySelectorAll('.report-customize-btn');

        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                reportCards.forEach(card => {
                    const reportName = card.getAttribute('data-report-name');
                    if (reportName.includes(searchTerm)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        // Category filter functionality
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const selectedCategory = tab.getAttribute('data-category');

                // Update active tab
                document.querySelectorAll('.slds-tabs_default__item').forEach(item => {
                    item.classList.remove('slds-is-active');
                });
                tab.closest('.slds-tabs_default__item').classList.add('slds-is-active');

                // Filter reports
                reportCards.forEach(card => {
                    const reportCategory = card.getAttribute('data-report-category');
                    if (selectedCategory === 'All' || reportCategory === selectedCategory) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Run Report button handlers
        runButtons.forEach(button => {
            button.addEventListener('click', () => {
                const reportName = button.getAttribute('data-report-name');
                alert(`In production, this would open the Salesforce standard report viewer for:\n\n"${reportName}"\n\nThe report would be rendered using Salesforce's native reporting engine.`);
            });
        });

        // Customize button handlers
        customizeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const reportName = button.getAttribute('data-report-name');
                alert(`In production, this would open the Salesforce report builder to customize:\n\n"${reportName}"\n\nAdmins could modify filters, columns, charts, and groupings using Salesforce's native report builder.`);
            });
        });
    },

    attachCallsPageListeners() {
        // Apply drilldown filters if context exists
        const drilldownContext = AppState.getDrilldownContext();
        if (drilldownContext && drilldownContext.page === 'calls') {
            // Apply the filter from drilldown context
            const filter = drilldownContext.filter;

            // Apply status filter if present
            if (filter.status) {
                const statusSelect = document.getElementById('filter-status');
                if (statusSelect && filter.status !== 'all') {
                    statusSelect.value = filter.status;
                }
            }

            // Apply direction filter if present
            if (filter.direction) {
                const directionSelect = document.getElementById('filter-direction');
                if (directionSelect) {
                    directionSelect.value = filter.direction;
                }
            }

            // Clear the context after applying so it doesn't persist
            AppState.clearDrilldownContext();

            // Apply the filters
            setTimeout(() => this.filterCalls(), 100);
        }

        // Attach view tab listeners (predefined views)
        const viewTabs = document.querySelectorAll('.calls-view-tab');
        viewTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = tab.getAttribute('data-view');

                // Update active tab
                document.querySelectorAll('.calls-view-tab').forEach(t => {
                    t.closest('.slds-tabs_default__item').classList.remove('slds-is-active');
                });
                tab.closest('.slds-tabs_default__item').classList.add('slds-is-active');

                // Apply view filter
                this.applyCallsView(viewId);
            });
        });

        // Attach filter listeners
        const searchInput = document.getElementById('filter-search');
        const dateInput = document.getElementById('filter-date');
        const statusSelect = document.getElementById('filter-status');
        const directionSelect = document.getElementById('filter-direction');
        const departmentSelect = document.getElementById('filter-department');
        const clearButton = document.getElementById('clear-filters');
        const exportButton = document.getElementById('export-calls');

        if (searchInput) {
            searchInput.addEventListener('input', () => this.filterCalls());
        }
        if (dateInput) {
            dateInput.addEventListener('change', () => this.filterCalls());
        }
        if (statusSelect) {
            statusSelect.addEventListener('change', () => this.filterCalls());
        }
        if (directionSelect) {
            directionSelect.addEventListener('change', () => this.filterCalls());
        }
        if (departmentSelect) {
            departmentSelect.addEventListener('change', () => this.filterCalls());
        }
        if (clearButton) {
            clearButton.addEventListener('click', (e) => {
                e.preventDefault();
                this.clearFilters();
            });
        }
        if (exportButton) {
            exportButton.addEventListener('click', () => this.exportCalls());
        }

        // Attach sorting listeners
        const sortableHeaders = document.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', (e) => {
                const sortField = e.currentTarget.getAttribute('data-sort');
                this.sortCalls(sortField);
            });
        });
    },

    attachSmsPageListeners() {
        // Attach view tab listeners (predefined views)
        const viewTabs = document.querySelectorAll('.sms-view-tab');
        viewTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = tab.getAttribute('data-view');

                // Update active tab
                document.querySelectorAll('.sms-view-tab').forEach(t => {
                    t.closest('.slds-tabs_default__item').classList.remove('slds-is-active');
                });
                tab.closest('.slds-tabs_default__item').classList.add('slds-is-active');

                // Apply view filter
                this.applySmsView(viewId);
            });
        });

        // Attach filter listeners
        const searchInput = document.getElementById('filter-sms-search');
        const dateInput = document.getElementById('filter-sms-date');
        const typeSelect = document.getElementById('filter-sms-type');
        const departmentSelect = document.getElementById('filter-sms-department');
        const clearButton = document.getElementById('clear-sms-filters');
        const exportButton = document.getElementById('export-sms');

        if (searchInput) {
            searchInput.addEventListener('input', () => this.filterSms());
        }
        if (dateInput) {
            dateInput.addEventListener('change', () => this.filterSms());
        }
        if (typeSelect) {
            typeSelect.addEventListener('change', () => this.filterSms());
        }
        if (departmentSelect) {
            departmentSelect.addEventListener('change', () => this.filterSms());
        }
        if (clearButton) {
            clearButton.addEventListener('click', (e) => {
                e.preventDefault();
                this.clearSmsFilters();
            });
        }
        if (exportButton) {
            exportButton.addEventListener('click', () => {
                alert('In production, this would export SMS messages to CSV format using Salesforce\'s native export functionality.');
            });
        }

        // Attach sorting listeners
        const sortableHeaders = document.querySelectorAll('.sortable-sms');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', (e) => {
                const sortField = e.currentTarget.getAttribute('data-sort');
                this.sortSms(sortField);
            });
        });
    },

    attachSettingsPageListeners() {
        // Accordion toggle functionality
        const accordionButtons = document.querySelectorAll('[data-accordion]');
        accordionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const section = button.closest('.slds-accordion__section');
                const contentId = button.getAttribute('data-accordion') + '-content';
                const content = document.getElementById(contentId);

                if (section.classList.contains('slds-is-open')) {
                    section.classList.remove('slds-is-open');
                    if (content) content.style.display = 'none';
                } else {
                    section.classList.add('slds-is-open');
                    if (content) content.style.display = 'block';
                }
            });
        });

        // Save Settings button
        const saveSettingsButton = document.getElementById('save-settings');
        if (saveSettingsButton) {
            saveSettingsButton.addEventListener('click', () => {
                // In production, this would save all settings via API
                this.showToast('Settings saved successfully!', 'success');
            });
        }

        // Cancel Settings button
        const cancelSettingsButton = document.getElementById('cancel-settings');
        if (cancelSettingsButton) {
            cancelSettingsButton.addEventListener('click', () => {
                // In production, this would revert changes
                this.showToast('Changes cancelled', 'info');
            });
        }

        // Test Connection button
        const testConnectionButton = document.getElementById('test-connection');
        if (testConnectionButton) {
            testConnectionButton.addEventListener('click', () => {
                this.showToast('Connection test successful! Integration is working properly.', 'success');
            });
        }

        // View Integration Logs link
        const viewLogsLink = document.getElementById('view-integration-logs');
        if (viewLogsLink) {
            viewLogsLink.addEventListener('click', (e) => {
                e.preventDefault();
                alert('In production, this would open the integration logs viewer showing sync history, errors, and audit trails.');
            });
        }

        // Add Users button (demo)
        const addUsersButtons = document.querySelectorAll('.slds-button_neutral');
        addUsersButtons.forEach(btn => {
            if (btn.textContent.includes('Add Users')) {
                btn.addEventListener('click', () => {
                    alert('In production, this would open a modal to select Salesforce users to connect with Dialpad.');
                });
            }
        });

        // Remove user buttons (demo)
        const removeButtons = document.querySelectorAll('.slds-button_destructive');
        removeButtons.forEach(btn => {
            if (btn.textContent === 'Remove') {
                btn.addEventListener('click', () => {
                    alert('In production, this would disconnect the user from Dialpad integration.');
                });
            }
        });

        // Enable/Disable number buttons (demo)
        const numberActionButtons = document.querySelectorAll('#numbers-content .slds-button');
        numberActionButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.textContent === 'Enable') {
                    alert('In production, this would enable call logging for this phone number.');
                } else if (btn.textContent === 'Disable') {
                    alert('In production, this would disable call logging for this phone number.');
                }
            });
        });
    },

    attachHomePageListeners(role) {
        // Setup Wizard button (admin only)
        if (role === 'admin') {
            const setupWizardButton = document.getElementById('start-setup-wizard');
            if (setupWizardButton) {
                setupWizardButton.addEventListener('click', () => {
                    alert('Setup Wizard will launch here!\n\nThis would guide admins through:\n1. Connect Dialpad account\n2. Configure call logging\n3. Map users\n4. Set up screen pop\n5. Configure quotas');
                });
            }

            // Admin sidebar navigation - using event delegation (only attach once)
            if (!this.adminSidebarDelegated) {
                document.addEventListener('click', (e) => {
                    const link = e.target.closest('[data-admin-section]');
                    if (link && RoleManager.getRole() === 'admin') {
                        e.preventDefault();
                        const sectionId = link.getAttribute('data-admin-section');
                        this.navigateAdminSection(sectionId);
                    }
                });
                this.adminSidebarDelegated = true;
            }

            // Date range filter (admin overview)
            const adminDateRangeSelect = document.getElementById('admin-date-range-select');
            if (adminDateRangeSelect) {
                adminDateRangeSelect.addEventListener('change', (e) => {
                    AppState.setDateRange(e.target.value);
                });
            }

            // Date range filter (admin analytics)
            const adminAnalyticsDateRangeSelect = document.getElementById('admin-analytics-date-range-select');
            if (adminAnalyticsDateRangeSelect) {
                adminAnalyticsDateRangeSelect.addEventListener('change', (e) => {
                    AppState.setDateRange(e.target.value);
                });
            }

            // Date range filter (supervisor dashboard)
            const supervisorDateRangeSelect = document.getElementById('supervisor-date-range-select');
            if (supervisorDateRangeSelect) {
                supervisorDateRangeSelect.addEventListener('change', (e) => {
                    AppState.setDateRange(e.target.value);
                });
            }

            // Date range filter (agent dashboard)
            const agentDateRangeSelect = document.getElementById('agent-date-range-select');
            if (agentDateRangeSelect) {
                agentDateRangeSelect.addEventListener('change', (e) => {
                    AppState.setDateRange(e.target.value);
                });
            }
        }

        // Date range filter (all roles)
        const dateRangeSelect = document.getElementById('date-range-select');
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', (e) => {
                AppState.setDateRange(e.target.value);
            });
        }

        // Metric card click handlers (all roles)
        const metricCards = document.querySelectorAll('.metric-card-clickable');
        metricCards.forEach(card => {
            card.addEventListener('click', () => {
                const metric = card.getAttribute('data-metric');
                this.handleMetricDrilldown(metric, role);
            });
        });
    },

    handleMetricDrilldown(metric, role) {
        // Set drilldown context and navigate to appropriate page
        switch(metric) {
            case 'calls':
                // Show all calls
                AppState.setDrilldownContext('calls', { status: 'all' });
                window.location.hash = '#/calls';
                break;
            case 'missed-calls':
                // Filter to missed calls only
                AppState.setDrilldownContext('calls', { status: 'Missed' });
                window.location.hash = '#/calls';
                break;
            case 'inbound-calls':
                // Filter to inbound calls only
                AppState.setDrilldownContext('calls', { direction: 'Inbound' });
                window.location.hash = '#/calls';
                break;
            case 'outbound-calls':
                // Filter to outbound calls only
                AppState.setDrilldownContext('calls', { direction: 'Outbound' });
                window.location.hash = '#/calls';
                break;
            case 'answered-calls':
                // Filter to answered calls only
                AppState.setDrilldownContext('calls', { status: 'Answered' });
                window.location.hash = '#/calls';
                break;
            case 'quota':
            case 'service-score':
            case 'calls-per-hour':
            case 'avg-duration':
                // Navigate to Reports page where all analytics live
                AppState.clearDrilldownContext();
                window.location.hash = '#/reports';
                break;
            default:
                // Default to calls page
                AppState.clearDrilldownContext();
                window.location.hash = '#/calls';
        }
    },

    showToast(message, type = 'success') {
        const toastContainer = document.createElement('div');
        toastContainer.className = 'slds-notify-container';
        toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';

        // Simple color scheme with good contrast
        const config = {
            success: { bg: '#4bca81', icon: 'success' },
            error: { bg: '#ea001e', icon: 'error' },
            warning: { bg: '#fe9339', icon: 'warning' },
            info: { bg: '#0176d3', icon: 'info' }
        };

        const { bg, icon } = config[type] || config.info;

        toastContainer.innerHTML = `
            <div class="slds-notify slds-notify_toast" role="status" style="background: ${bg}; color: white; border: none;">
                <span class="slds-assistive-text">${type}</span>
                <span class="slds-icon_container slds-m-right_small" style="background: transparent;">
                    <svg class="slds-icon slds-icon_small" aria-hidden="true" style="fill: white;">
                        <use xlink:href="${getAssetPath(`assets/icons/utility-sprite/svg/symbols.svg#${icon}`)}"></use>
                    </svg>
                </span>
                <div class="slds-notify__content">
                    <h2 class="slds-text-heading_small" style="color: white;">${message}</h2>
                </div>
                <div class="slds-notify__close">
                    <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" style="color: white;">
                        <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true" style="fill: white;">
                            <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#close")}"></use>
                        </svg>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(toastContainer);

        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            toastContainer.remove();
        }, 3000);

        // Close button
        const closeBtn = toastContainer.querySelector('.slds-button_icon-inverse');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                toastContainer.remove();
            });
        }
    },

    applyCallsView(viewId) {
        // Store current view in app state for persistence during filtering
        this.currentCallsView = viewId;

        // Apply the filter with the current view
        this.filterCalls();
    },

    filterCalls() {
        const role = RoleManager.getRole();
        let calls = DataService.getCalls(role);

        // Apply view filter (predefined views)
        const currentView = this.currentCallsView || (role === 'agent' ? 'my-calls' : 'team-calls');

        if (currentView === 'my-calls') {
            // Filter to only current user's calls
            const currentUser = role === 'agent' ? 'Sarah Johnson' : RoleManager.getCurrentUserName();
            calls = calls.filter(call => call.userName === currentUser);
        } else if (currentView === 'team-calls') {
            // For supervisors/admins: filter to their team/department
            // In production, this would use actual team/department membership
            // For demo, we'll show a subset of users
            const teamMembers = ['Sarah Johnson', 'Mike Chen', 'Emily Davis'];
            calls = calls.filter(call => teamMembers.includes(call.userName));
        }
        // 'all-calls' shows everything (no additional filter)

        // Apply search filter
        const search = document.getElementById('filter-search')?.value.toLowerCase();
        if (search) {
            calls = calls.filter(call =>
                call.contact.toLowerCase().includes(search) ||
                (call.userName && call.userName.toLowerCase().includes(search))
            );
        }

        // Apply department filter (for admin/supervisor only)
        const department = document.getElementById('filter-department')?.value;
        if (department) {
            // In production, this would filter by actual user department
            // For demo, we'll simulate department filtering
            calls = calls.filter(call => {
                // Mock department assignment based on user name
                const deptMap = {
                    'Sarah Johnson': 'Sales',
                    'Mike Chen': 'Support',
                    'Emily Davis': 'Sales',
                    'John Smith': 'Customer Success',
                    'Lisa Wong': 'Marketing'
                };
                return deptMap[call.userName] === department;
            });
        }

        // Apply date filter
        const date = document.getElementById('filter-date')?.value;
        if (date) {
            calls = calls.filter(call => {
                const callDate = new Date(call.timestamp).toISOString().split('T')[0];
                return callDate === date;
            });
        }

        // Apply status filter
        const status = document.getElementById('filter-status')?.value;
        if (status) {
            calls = calls.filter(call => call.status === status);
        }

        // Apply direction filter
        const direction = document.getElementById('filter-direction')?.value;
        if (direction) {
            calls = calls.filter(call => call.direction === direction);
        }

        this.updateCallsTable(calls);
    },

    sortCalls(field) {
        if (!this.sortState) {
            this.sortState = { field: null, direction: 'asc' };
        }

        // Toggle direction if same field, otherwise default to asc
        if (this.sortState.field === field) {
            this.sortState.direction = this.sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortState.field = field;
            this.sortState.direction = 'asc';
        }

        const role = RoleManager.getRole();
        let calls = DataService.getCalls(role);

        // Apply current filters first
        const search = document.getElementById('filter-search')?.value.toLowerCase();
        const date = document.getElementById('filter-date')?.value;
        const status = document.getElementById('filter-status')?.value;
        const direction = document.getElementById('filter-direction')?.value;

        if (search) {
            calls = calls.filter(call =>
                call.contact.toLowerCase().includes(search) ||
                (call.userName && call.userName.toLowerCase().includes(search))
            );
        }
        if (date) {
            calls = calls.filter(call => {
                const callDate = new Date(call.timestamp).toISOString().split('T')[0];
                return callDate === date;
            });
        }
        if (status) {
            calls = calls.filter(call => call.status === status);
        }
        if (direction) {
            calls = calls.filter(call => call.direction === direction);
        }

        // Sort calls
        calls.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];

            if (field === 'timestamp') {
                aVal = new Date(aVal).getTime();
                bVal = new Date(bVal).getTime();
            } else if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (this.sortState.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        // Update sort indicators
        document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
        const activeHeader = document.querySelector(`[data-sort="${field}"] .sort-indicator`);
        if (activeHeader) {
            activeHeader.textContent = this.sortState.direction === 'asc' ? ' ▲' : ' ▼';
        }

        this.updateCallsTable(calls);
    },

    updateCallsTable(calls) {
        const role = RoleManager.getRole();
        const tbody = document.getElementById('calls-table-body');
        const countHeader = document.getElementById('calls-count');

        if (tbody) {
            tbody.innerHTML = calls.map(call => `
                <tr>
                    <td>${DataService.formatTimestamp(call.timestamp)}</td>
                    <td>${call.contact}</td>
                    <td>${call.direction}</td>
                    <td>${DataService.formatDuration(call.duration)}</td>
                    <td>${call.status}</td>
                    <td>${call.disposition}</td>
                    ${role !== 'agent' ? `<td>${call.userName}</td>` : ''}
                </tr>
            `).join('');
        }

        if (countHeader) {
            countHeader.textContent = `Call History (${calls.length} records)`;
        }
    },

    clearFilters() {
        document.getElementById('filter-search').value = '';
        document.getElementById('filter-date').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-direction').value = '';
        this.filterCalls();
    },

    exportCalls() {
        const role = RoleManager.getRole();
        const calls = DataService.getCalls(role);

        // Create CSV content
        const headers = role !== 'agent'
            ? ['Time', 'Contact', 'Direction', 'Duration', 'Status', 'Disposition', 'User']
            : ['Time', 'Contact', 'Direction', 'Duration', 'Status', 'Disposition'];

        const csvRows = [headers.join(',')];

        calls.forEach(call => {
            const row = [
                DataService.formatTimestamp(call.timestamp),
                call.contact,
                call.direction,
                DataService.formatDuration(call.duration),
                call.status,
                call.disposition
            ];
            if (role !== 'agent') {
                row.push(call.userName);
            }
            csvRows.push(row.join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `calls-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    },

    // SMS Page Methods
    applySmsView(viewId) {
        this.currentSmsView = viewId;
        this.filterSms();
    },

    filterSms() {
        const role = RoleManager.getRole();
        let messages = DataService.getCalls(role).slice(0, 15).map(call => ({
            ...call,
            messagePreview: 'Sample SMS message text...',
            type: call.direction === 'Inbound' ? 'Received' : 'Sent'
        }));

        // Apply view filter
        const currentView = this.currentSmsView || (role === 'agent' ? 'my-sms' : 'team-sms');

        if (currentView === 'my-sms') {
            const currentUser = role === 'agent' ? 'Sarah Johnson' : RoleManager.getCurrentUserName();
            messages = messages.filter(msg => msg.userName === currentUser);
        } else if (currentView === 'team-sms') {
            const teamMembers = ['Sarah Johnson', 'Mike Chen', 'Emily Davis'];
            messages = messages.filter(msg => teamMembers.includes(msg.userName));
        }

        // Apply search filter
        const search = document.getElementById('filter-sms-search')?.value.toLowerCase();
        if (search) {
            messages = messages.filter(msg =>
                msg.contact.toLowerCase().includes(search) ||
                msg.messagePreview.toLowerCase().includes(search) ||
                (msg.userName && msg.userName.toLowerCase().includes(search))
            );
        }

        // Apply department filter
        const department = document.getElementById('filter-sms-department')?.value;
        if (department) {
            const deptMap = {
                'Sarah Johnson': 'Sales',
                'Mike Chen': 'Support',
                'Emily Davis': 'Sales',
                'John Smith': 'Customer Success',
                'Lisa Wong': 'Marketing'
            };
            messages = messages.filter(msg => deptMap[msg.userName] === department);
        }

        // Apply date filter
        const date = document.getElementById('filter-sms-date')?.value;
        if (date) {
            messages = messages.filter(msg => {
                const msgDate = new Date(msg.timestamp).toISOString().split('T')[0];
                return msgDate === date;
            });
        }

        // Apply type filter
        const type = document.getElementById('filter-sms-type')?.value;
        if (type) {
            messages = messages.filter(msg => msg.type === type);
        }

        this.updateSmsTable(messages);
    },

    sortSms(field) {
        if (!this.smsSortState) {
            this.smsSortState = { field: null, direction: 'asc' };
        }

        if (this.smsSortState.field === field) {
            this.smsSortState.direction = this.smsSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.smsSortState.field = field;
            this.smsSortState.direction = 'asc';
        }

        const role = RoleManager.getRole();
        let messages = DataService.getCalls(role).slice(0, 15).map(call => ({
            ...call,
            messagePreview: 'Sample SMS message text...',
            type: call.direction === 'Inbound' ? 'Received' : 'Sent'
        }));

        // Sort
        messages.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];

            if (field === 'timestamp') {
                aVal = new Date(aVal).getTime();
                bVal = new Date(bVal).getTime();
            }

            if (this.smsSortState.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        this.updateSmsTable(messages);

        // Update sort indicators
        document.querySelectorAll('.sortable-sms .sort-indicator').forEach(indicator => {
            indicator.textContent = '';
        });
        const activeHeader = document.querySelector(`.sortable-sms[data-sort="${field}"] .sort-indicator`);
        if (activeHeader) {
            activeHeader.textContent = this.smsSortState.direction === 'asc' ? '↑' : '↓';
        }
    },

    updateSmsTable(messages) {
        const role = RoleManager.getRole();
        const tbody = document.getElementById('sms-table-body');
        const countEl = document.getElementById('sms-count');

        if (!tbody) return;

        tbody.innerHTML = messages.map(msg => `
            <tr>
                <td>${DataService.formatTimestamp(msg.timestamp)}</td>
                <td>${msg.contact}</td>
                <td>${msg.type}</td>
                <td>${msg.messagePreview}</td>
                ${role !== 'agent' ? `<td>${msg.userName}</td>` : ''}
            </tr>
        `).join('');

        if (countEl) {
            countEl.textContent = `Message History (${messages.length} records)`;
        }
    },

    clearSmsFilters() {
        document.getElementById('filter-sms-search').value = '';
        document.getElementById('filter-sms-date').value = '';
        document.getElementById('filter-sms-type').value = '';
        const deptFilter = document.getElementById('filter-sms-department');
        if (deptFilter) deptFilter.value = '';
        this.filterSms();
    },

    getAgentStateClass(state) {
        const stateMap = {
            'On Call': 'state-on-call',
            'Available': 'state-available',
            'Wrap-Up': 'state-wrap-up',
            'Break': 'state-break',
            'Offline': 'state-offline'
        };
        return stateMap[state] || 'state-offline';
    },

    attachDemoControlListeners() {
        // Toggle demo controls panel
        const trigger = document.getElementById('demo-controls-trigger');
        const panel = document.getElementById('demo-controls-panel');
        const closeBtn = document.getElementById('close-demo-controls');

        if (trigger) {
            trigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Prevent document click from immediately closing
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                panel.style.display = 'none';
            });
        }

        // Close panel when clicking outside
        if (panel) {
            // Prevent clicks inside panel from closing it
            panel.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Close panel when clicking anywhere on the document
            document.addEventListener('click', (e) => {
                if (panel.style.display !== 'none' && !panel.contains(e.target) && e.target !== trigger) {
                    panel.style.display = 'none';
                }
            });
        }

        // Onboarding trigger
        const onboardingBtn = document.getElementById('trigger-onboarding');
        if (onboardingBtn) {
            onboardingBtn.addEventListener('click', () => {
                this.showOnboardingModal();
            });
        }

        // Feature tour trigger
        const tourBtn = document.getElementById('trigger-tour');
        if (tourBtn) {
            tourBtn.addEventListener('click', () => {
                this.startFeatureTour();
            });
        }

        // Version banner toggle
        const versionToggle = document.getElementById('toggle-version-banner');
        if (versionToggle) {
            versionToggle.addEventListener('change', (e) => {
                AppState.setVersionBanner(e.target.checked);
            });
        }

        // Changelog trigger
        const changelogBtn = document.getElementById('show-changelog');
        if (changelogBtn) {
            changelogBtn.addEventListener('click', () => {
                this.showChangelogModal();
            });
        }

        // Environment radio buttons
        const envRadios = document.querySelectorAll('input[name="environment"]');
        envRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                AppState.setEnvironment(e.target.value);
                this.renderCurrentPage();
            });
        });

        // Sandbox warning toggle
        const sandboxToggle = document.getElementById('toggle-sandbox-warning');
        if (sandboxToggle) {
            sandboxToggle.addEventListener('change', (e) => {
                AppState.showSandboxWarning = e.target.checked;
                this.renderCurrentPage();
            });
        }

        // Integration status radio buttons
        const integrationRadios = document.querySelectorAll('input[name="integration-status"]');
        integrationRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                AppState.setIntegrationStatus(e.target.value);
                this.renderCurrentPage();
            });
        });

        // Config warning toggle
        const configWarningToggle = document.getElementById('toggle-config-warning');
        if (configWarningToggle) {
            configWarningToggle.addEventListener('change', (e) => {
                AppState.showConfigWarning = e.target.checked;
                this.renderCurrentPage();
            });
        }

        // Unlogged calls slider
        const unloggedSlider = document.getElementById('unlogged-count');
        const unloggedValue = document.getElementById('unlogged-value');
        if (unloggedSlider) {
            unloggedSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                unloggedValue.textContent = value;
                AppState.setUnloggedCallsCount(value);
                this.renderCurrentPage();
            });
        }

        // Quota progress slider
        const quotaSlider = document.getElementById('quota-progress');
        const quotaValue = document.getElementById('quota-value');
        if (quotaSlider) {
            quotaSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                quotaValue.textContent = value;
                AppState.setAgentQuota('1', value, 100);
                this.renderCurrentPage();
            });
        }

        // Reset demo state
        const resetBtn = document.getElementById('reset-demo-state');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                if (confirm('Reset all demo states to defaults?')) {
                    localStorage.clear();
                    location.reload();
                }
            });
        }
    },


    handleStateChange(detail) {
        // Handle state changes from AppState
        console.log('State changed:', detail.type, detail.value);
        // Re-render current page to reflect state changes
        if (['unloggedCalls', 'agentQuota', 'environment', 'dateRange', 'integrationStatus', 'versionBanner'].includes(detail.type)) {
            this.renderCurrentPage();
        }
        // Update notification badge for relevant state changes
        if (['unloggedCalls', 'integrationStatus', 'configWarning'].includes(detail.type)) {
            this.updateNotificationBadge();
        }
    },

    showOnboardingModal() {
        const modalsContainer = document.getElementById('modals-container');
        if (!modalsContainer) return;

        AppState.onboardingStep = 1;
        this.renderOnboardingModal();
    },

    renderOnboardingModal() {
        const modalsContainer = document.getElementById('modals-container');
        const step = AppState.onboardingStep;

        const steps = [
            {
                title: 'Welcome to Dialpad for Salesforce!',
                content: `
                    <div class="slds-text-align_center slds-m-bottom_large">
                        <div class="slds-illustration slds-illustration_large" style="margin: 0 auto;">
                            <svg class="slds-illustration__svg" viewBox="0 0 468 194" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                                <g fill="none" fill-rule="evenodd">
                                    <g transform="translate(0 5)">
                                        <circle cx="150" cy="94" r="94" fill="#E3F3FF"/>
                                        <path d="M150,20 C150,20 180,60 180,94 C180,128 165,150 150,150 C135,150 120,128 120,94 C120,60 150,20 150,20 Z" fill="#0176D3"/>
                                    </g>
                                </g>
                            </svg>
                        </div>
                    </div>
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        Get the most out of your Dialpad integration with this quick setup guide.
                        We'll walk you through best practices and key features in just a few steps.
                    </p>
                    <div class="slds-box slds-box_x-small slds-theme_shade slds-m-top_medium">
                        <p class="slds-text-body_small"><strong>Estimated time:</strong> 3 minutes</p>
                    </div>
                `
            },
            {
                title: 'Test in Sandbox First',
                content: `
                    <div class="slds-media slds-media_center slds-m-bottom_medium">
                        <div class="slds-media__figure">
                            <span class="slds-icon_container slds-icon-utility-warning" style="background-color: #FE9339;">
                                <span style="font-size: 2rem;">⚠️</span>
                            </span>
                        </div>
                        <div class="slds-media__body">
                            <h3 class="slds-text-heading_small">Always test in Sandbox before Production</h3>
                        </div>
                    </div>
                    <p class="slds-m-bottom_medium">
                        We strongly recommend testing all package updates and configurations in a Sandbox environment before deploying to Production.
                    </p>
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h4 class="slds-text-heading_small slds-m-bottom_small">Best practices:</h4>
                        <ul class="slds-list_dotted">
                            <li>Create a full copy Sandbox of your Production org</li>
                            <li>Install or update the Dialpad package in Sandbox</li>
                            <li>Test all features with real users</li>
                            <li>Verify call logging and data sync</li>
                            <li>Only then deploy to Production</li>
                        </ul>
                    </div>
                    <label class="slds-checkbox">
                        <input type="checkbox" id="sandbox-acknowledge" />
                        <span class="slds-checkbox_faux"></span>
                        <span class="slds-form-element__label">I understand and will test in Sandbox first</span>
                    </label>
                `
            },
            {
                title: 'Configure Call Logging',
                content: `
                    <p class="slds-m-bottom_medium">
                        Dialpad can automatically log all your calls to Salesforce. Let's make sure it's configured correctly.
                    </p>
                    <div class="slds-box slds-theme_default slds-m-bottom_medium">
                        <div class="slds-media">
                            <div class="slds-media__figure">
                                <span class="slds-icon_container slds-icon-standard-task" style="background-color: #0176D3;">
                                    <span style="font-size: 1.5rem; color: white;">✓</span>
                                </span>
                            </div>
                            <div class="slds-media__body">
                                <h4 class="slds-text-heading_small">Recommended Settings</h4>
                                <ul class="slds-list_dotted slds-m-top_x-small">
                                    <li>Enable auto-log for all calls</li>
                                    <li>Set default call owner to user making the call</li>
                                    <li>Log calls to related Contact or Lead</li>
                                    <li>Include call recordings (if enabled)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <button class="slds-button slds-button_neutral" onclick="App.goToSettings()">
                        Go to Settings
                    </button>
                `
            },
            {
                title: 'Explore Your Dashboard',
                content: `
                    <p class="slds-m-bottom_medium">
                        Your dashboard shows different metrics based on your role. You can switch roles using the links in the header.
                    </p>
                    <div class="slds-grid slds-wrap slds-gutters_small slds-m-bottom_medium">
                        <div class="slds-col slds-size_1-of-3">
                            <div class="slds-box slds-box_x-small slds-text-align_center">
                                <div class="slds-m-bottom_x-small" style="font-size: 2rem;">👤</div>
                                <div class="slds-text-heading_small">Admin</div>
                                <p class="slds-text-body_small">Company-wide metrics, user management</p>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-3">
                            <div class="slds-box slds-box_x-small slds-text-align_center">
                                <div class="slds-m-bottom_x-small" style="font-size: 2rem;">👥</div>
                                <div class="slds-text-heading_small">Supervisor</div>
                                <p class="slds-text-body_small">Team performance, agent monitoring</p>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-3">
                            <div class="slds-box slds-box_x-small slds-text-align_center">
                                <div class="slds-m-bottom_x-small" style="font-size: 2rem;">📞</div>
                                <div class="slds-text-heading_small">Agent</div>
                                <p class="slds-text-body_small">Personal stats, call history, quotas</p>
                            </div>
                        </div>
                    </div>
                    <div class="slds-box slds-theme_info slds-theme_alert-texture">
                        <p class="slds-text-body_small">
                            <strong>Tip:</strong> Data refreshes automatically every 30 seconds on the Home page.
                        </p>
                    </div>
                `
            },
            {
                title: 'Access Pre-built Reports',
                content: `
                    <p class="slds-m-bottom_medium">
                        We've included 20 pre-built reports to help you analyze your call data. Find them in the Reports tab.
                    </p>
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h4 class="slds-text-heading_small slds-m-bottom_small">Report Categories:</h4>
                        <div class="slds-grid slds-wrap slds-gutters_xx-small">
                            <div class="slds-col slds-size_1-of-2">
                                <span class="slds-badge slds-theme_default">Call Activity</span>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <span class="slds-badge slds-theme_default">Performance</span>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <span class="slds-badge slds-theme_default">Quality</span>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <span class="slds-badge slds-theme_default">Powerdialer</span>
                            </div>
                        </div>
                    </div>
                    <div class="slds-box slds-theme_success slds-theme_alert-texture">
                        <p class="slds-text-body_small">
                            ✓ All reports sync with your Dialpad analytics dashboard
                        </p>
                    </div>
                    <button class="slds-button slds-button_neutral slds-m-top_small" onclick="App.goToReports()">
                        View Reports
                    </button>
                `
            },
            {
                title: 'You\'re All Set!',
                content: `
                    <div class="slds-text-align_center slds-m-bottom_large">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
                        <h3 class="slds-text-heading_medium slds-m-bottom_small">Setup Complete!</h3>
                        <p class="slds-text-body_regular">You\'re ready to start using Dialpad for Salesforce.</p>
                    </div>
                    <div class="slds-box slds-theme_shade">
                        <h4 class="slds-text-heading_small slds-m-bottom_small">What's next?</h4>
                        <ul class="slds-list_dotted">
                            <li>Make test calls and verify they log correctly</li>
                            <li>Set up agent quotas in Settings</li>
                            <li>Customize your dashboard widgets</li>
                            <li>Train your team on the new features</li>
                            <li>Explore the Reports library</li>
                        </ul>
                    </div>
                    <div class="slds-box slds-theme_info slds-theme_alert-texture slds-m-top_medium">
                        <p class="slds-text-body_small">
                            <strong>Need help?</strong> Visit our Help Center or contact Support.
                        </p>
                    </div>
                `
            }
        ];

        const currentStep = steps[step - 1];
        const progressPercent = Math.round((step / steps.length) * 100);

        modalsContainer.innerHTML = `
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-modal="true">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <h2 class="slds-modal__title slds-hyphenate">
                            ${currentStep.title}
                        </h2>
                        <p class="slds-m-top_x-small">Step ${step} of ${steps.length}</p>
                        <div class="slds-progress-bar slds-progress-bar_x-small slds-m-top_small" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${progressPercent}">
                            <span class="slds-progress-bar__value" style="width: ${progressPercent}%;"></span>
                        </div>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        ${currentStep.content}
                    </div>
                    <footer class="slds-modal__footer">
                        ${step > 1 ? '<button class="slds-button slds-button_neutral" id="onboarding-prev">Previous</button>' : ''}
                        <button class="slds-button slds-button_neutral" id="onboarding-skip">Skip Tutorial</button>
                        ${step < steps.length ?
                            '<button class="slds-button slds-button_brand" id="onboarding-next">Next</button>' :
                            '<button class="slds-button slds-button_brand" id="onboarding-finish">Get Started</button>'
                        }
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        `;

        // Attach event listeners
        setTimeout(() => {
            const nextBtn = document.getElementById('onboarding-next');
            const prevBtn = document.getElementById('onboarding-prev');
            const skipBtn = document.getElementById('onboarding-skip');
            const finishBtn = document.getElementById('onboarding-finish');

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    // On step 2, check if sandbox acknowledged
                    if (step === 2) {
                        const checkbox = document.getElementById('sandbox-acknowledge');
                        if (!checkbox.checked) {
                            alert('Please acknowledge that you will test in Sandbox first.');
                            return;
                        }
                        AppState.hasTestedInSandbox = true;
                    }
                    AppState.onboardingStep++;
                    this.renderOnboardingModal();
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    AppState.onboardingStep--;
                    this.renderOnboardingModal();
                });
            }

            if (skipBtn) {
                skipBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to skip the tutorial?')) {
                        this.closeOnboardingModal();
                    }
                });
            }

            if (finishBtn) {
                finishBtn.addEventListener('click', () => {
                    AppState.setOnboardingComplete();
                    this.closeOnboardingModal();
                });
            }
        }, 0);
    },

    closeOnboardingModal() {
        const modalsContainer = document.getElementById('modals-container');
        if (modalsContainer) {
            modalsContainer.innerHTML = '';
        }
    },

    goToSettings() {
        this.closeOnboardingModal();
        this.renderPage('settings');
    },

    goToReports() {
        this.closeOnboardingModal();
        this.renderPage('reports');
    },

    startFeatureTour() {
        alert('Feature Tour: Interactive tooltips will guide you through:\n- Switching roles\n- Using filters\n- Exploring reports\n- Exporting data\n\n(Feature tours with popovers can be added in Phase 2)');
    },

    showChangelogModal() {
        const modalsContainer = document.getElementById('modals-container');
        if (!modalsContainer) return;

        modalsContainer.innerHTML = `
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-modal="true">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" id="close-changelog">
                            <span class="slds-icon_container">✕</span>
                            <span class="slds-assistive-text">Close</span>
                        </button>
                        <h2 class="slds-modal__title slds-hyphenate">
                            What's New in Dialpad for Salesforce
                        </h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">

                        <!-- Version 2.5.0 -->
                        <article class="slds-box slds-m-bottom_medium">
                            <div class="slds-media slds-media_center slds-m-bottom_small">
                                <div class="slds-media__figure">
                                    <span class="slds-badge slds-theme_success">LATEST</span>
                                </div>
                                <div class="slds-media__body">
                                    <h3 class="slds-text-heading_small">Version 2.5.0</h3>
                                    <p class="slds-text-color_weak">Released November 15, 2025</p>
                                </div>
                            </div>

                            <div class="slds-m-bottom_medium">
                                <h4 class="slds-text-title_caps slds-m-bottom_x-small">✨ New Features</h4>
                                <ul class="slds-list_dotted">
                                    <li><strong>Real-time Agent State Tracking:</strong> Monitor agent availability with 5 color-coded states</li>
                                    <li><strong>20 Pre-built Reports:</strong> Comprehensive report library across 5 categories</li>
                                    <li><strong>Advanced Filtering:</strong> Real-time search and multi-criteria filtering on Calls page</li>
                                    <li><strong>Quota Tracking:</strong> Visual progress bars for agent daily/weekly quotas</li>
                                    <li><strong>Unlogged Call Alerts:</strong> Automatic detection and notifications for unlogged calls</li>
                                    <li><strong>Auto-refresh Dashboard:</strong> Live updates every 30 seconds</li>
                                </ul>
                            </div>

                            <div class="slds-m-bottom_medium">
                                <h4 class="slds-text-title_caps slds-m-bottom_x-small">🔧 Improvements</h4>
                                <ul class="slds-list_dotted">
                                    <li>Dashboard loading performance improved by 40%</li>
                                    <li>Chart rendering now uses Chart.js 4.4.0 for better visuals</li>
                                    <li>Enhanced user table with pickup rates and avg duration</li>
                                    <li>Sortable columns on all data tables</li>
                                    <li>CSV export with filtered data support</li>
                                </ul>
                            </div>

                            <div>
                                <h4 class="slds-text-title_caps slds-m-bottom_x-small">🐛 Bug Fixes</h4>
                                <ul class="slds-list_dotted">
                                    <li>Fixed call logging sync issues with recordings</li>
                                    <li>Resolved timezone display inconsistencies</li>
                                    <li>Fixed Powerdialer list assignment permissions</li>
                                    <li>Corrected report calculations to match Dialpad analytics</li>
                                </ul>
                            </div>
                        </article>

                        <!-- Version 2.3.0 -->
                        <article class="slds-box slds-theme_shade slds-m-bottom_medium">
                            <div class="slds-media slds-media_center slds-m-bottom_small">
                                <div class="slds-media__body">
                                    <h3 class="slds-text-heading_small">Version 2.3.0</h3>
                                    <p class="slds-text-color_weak">Released October 1, 2025</p>
                                </div>
                            </div>

                            <div class="slds-m-bottom_medium">
                                <h4 class="slds-text-title_caps slds-m-bottom_x-small">✨ New Features</h4>
                                <ul class="slds-list_dotted">
                                    <li>Role-based dashboards for Admin, Supervisor, and Agent</li>
                                    <li>7 interactive chart types</li>
                                    <li>SMS message logging and history</li>
                                    <li>Powerdialer integration with list management</li>
                                </ul>
                            </div>

                            <div>
                                <h4 class="slds-text-title_caps slds-m-bottom_x-small">🔧 Improvements</h4>
                                <ul class="slds-list_dotted">
                                    <li>Upgraded to Salesforce Lightning Design System 2.24</li>
                                    <li>Improved mobile responsiveness</li>
                                    <li>Better error handling and logging</li>
                                </ul>
                            </div>
                        </article>

                        <!-- Version 2.1.0 -->
                        <article class="slds-box slds-theme_shade">
                            <div class="slds-media slds-media_center slds-m-bottom_small">
                                <div class="slds-media__body">
                                    <h3 class="slds-text-heading_small">Version 2.1.0</h3>
                                    <p class="slds-text-color_weak">Released August 12, 2025</p>
                                </div>
                            </div>

                            <div class="slds-m-bottom_medium">
                                <h4 class="slds-text-title_caps slds-m-bottom_x-small">✨ New Features</h4>
                                <ul class="slds-list_dotted">
                                    <li>Basic call logging to Salesforce records</li>
                                    <li>Click-to-dial from Salesforce</li>
                                    <li>Call history view</li>
                                </ul>
                            </div>
                        </article>

                    </div>
                    <footer class="slds-modal__footer">
                        <button class="slds-button slds-button_neutral" id="close-changelog-btn">Close</button>
                        <button class="slds-button slds-button_brand" id="update-now-btn">Update to 2.5.0</button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        `;

        // Attach event listeners
        setTimeout(() => {
            const closeBtn = document.getElementById('close-changelog');
            const closeFooterBtn = document.getElementById('close-changelog-btn');
            const updateBtn = document.getElementById('update-now-btn');

            const closeModal = () => {
                modalsContainer.innerHTML = '';
                AppState.hasViewedChangelog = true;
            };

            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (closeFooterBtn) closeFooterBtn.addEventListener('click', closeModal);

            if (updateBtn) {
                updateBtn.addEventListener('click', () => {
                    alert('In a real implementation, this would redirect to:\n\nSalesforce AppExchange:\nhttps://appexchange.salesforce.com/dialpad\n\nOr directly to package installation URL.');
                    closeModal();
                });
            }
        }, 0);
    },

    renderUnloggedCallsAlert() {
        const count = AppState.unloggedCallsCount;

        if (count === 0) {
            return `
                <div class="slds-card">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Call Logging</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="slds-text-align_center slds-p-around_medium">
                            <div style="font-size: 3rem; color: #04844b; margin-bottom: 0.5rem;">✓</div>
                            <p class="slds-text-heading_small slds-m-bottom_x-small">All Calls Logged</p>
                            <p class="slds-text-body_small slds-text-color_weak">Great job! No unlogged calls detected.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        const unloggedCalls = DataService.getUnloggedCalls(count);

        return `
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Unlogged Calls</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-p-vertical_medium slds-m-bottom_medium slds-border_bottom">
                        <div class="slds-text-heading_large slds-text-color_error slds-m-bottom_xxx-small">${count}</div>
                        <p class="slds-text-body_small slds-text-color_default">
                            ${count === 1 ? 'call needs' : 'calls need'} to be logged
                        </p>
                    </div>

                    <div class="slds-m-vertical_small">
                        ${unloggedCalls.map((call, index) => `
                            <div class="slds-p-around_small ${index < unloggedCalls.length - 1 ? 'slds-border_bottom' : ''}">
                                <div class="slds-grid slds-grid_vertical-align-start slds-m-bottom_xxx-small">
                                    <div class="slds-col slds-has-flexi-truncate">
                                        <p class="slds-text-body_small slds-text-title">${call.contact}</p>
                                    </div>
                                    <div class="slds-col slds-no-flex slds-text-align_right">
                                        <p class="slds-text-body_small slds-text-title slds-text-color_error">${DataService.formatDuration(call.duration)}</p>
                                    </div>
                                </div>
                                <div class="slds-grid slds-grid_vertical-align-start">
                                    <div class="slds-col">
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            ${call.userName}
                                        </p>
                                    </div>
                                    <div class="slds-col slds-no-flex slds-text-align_right">
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            ${call.direction} • ${DataService.formatTimestamp(call.timestamp)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button class="slds-button slds-button_brand slds-button_stretch" onclick="alert('This would open a modal to review and log these calls to Salesforce.')">
                        Log All Calls
                    </button>
                </div>
            </div>
        `;
    },

    renderPackageUpdateStatus() {
        const needsUpdate = AppState.needsUpdate();

        if (needsUpdate) {
            return `
                <div class="slds-card slds-m-top_medium">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Package Update</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="slds-box slds-box_small slds-theme_shade slds-m-bottom_small" style="border-left: 4px solid #0176d3;">
                            <div class="slds-p-around_small">
                                <p class="slds-text-heading_small slds-m-bottom_x-small">Update Available</p>
                                <p class="slds-text-body_small slds-text-color_default">
                                    Version ${AppState.latestVersion} is available
                                </p>
                                <p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                    Current: ${AppState.currentVersion}
                                </p>
                            </div>
                        </div>
                        <p class="slds-text-body_small slds-m-bottom_small">
                            A new version of the Dialpad package is available with bug fixes and feature improvements.
                        </p>
                        <button class="slds-button slds-button_brand slds-button_stretch" id="view-changelog-widget">
                            View Changelog
                        </button>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Package Version</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-p-around_medium">
                        <div style="font-size: 3rem; color: #04844b; margin-bottom: 0.5rem;">✓</div>
                        <p class="slds-text-heading_small slds-m-bottom_x-small">Up to Date</p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            Running version ${AppState.currentVersion}
                        </p>
                    </div>
                </div>
            </div>
        `;
    },

    renderIntegrationHealth() {
        const isConnected = AppState.integrationStatus === 'connected';
        const lastSync = AppState.getLastSyncTime();
        const hasWarning = AppState.showConfigWarning;

        if (!isConnected) {
            return `
                <div class="slds-card slds-m-top_medium">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Integration Health</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="slds-box slds-box_small slds-theme_shade slds-m-bottom_small" style="border-left: 4px solid #c23934;">
                            <div class="slds-text-align_center slds-p-around_small">
                                <div class="slds-text-heading_large" style="font-size: 2.5rem; font-weight: bold; color: #c23934;">!</div>
                                <p class="slds-text-heading_small slds-text-color_default">
                                    Disconnected
                                </p>
                            </div>
                        </div>
                        <p class="slds-text-body_small slds-m-bottom_small">
                            The Dialpad integration is not connected to Salesforce. Call logging and data sync are disabled.
                        </p>
                        <button class="slds-button slds-button_brand slds-button_stretch" onclick="alert('This would open connection settings to troubleshoot the issue.')">
                            Reconnect Integration
                        </button>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Integration Health</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-align_center slds-p-around_medium slds-m-bottom_small">
                        <div style="font-size: 3rem; color: #04844b; margin-bottom: 0.5rem;">✓</div>
                        <p class="slds-text-heading_small slds-m-bottom_x-small">Connected</p>
                        <p class="slds-text-body_small slds-text-color_weak">
                            Last sync: ${lastSync}
                        </p>
                    </div>
                    ${hasWarning ? `
                        <div class="slds-box slds-box_small slds-theme_shade" style="border-left: 4px solid #ffb75d;">
                            <p class="slds-text-body_small slds-text-color_default">
                                <strong>Configuration Notice:</strong> Some settings may need review in the Settings tab.
                            </p>
                        </div>
                    ` : ''}
                    <button class="slds-button slds-button_neutral slds-button_stretch slds-m-top_x-small" onclick="alert('This would test the Salesforce connection and show detailed status.')">
                        Test Connection
                    </button>
                </div>
            </div>
        `;
    },

    renderQuotaProgress() {
        const userId = window.RoleManager?.currentUserId || '005xx000001X8Uz';
        const quota = AppState.getQuotaStatus(userId);
        const percentComplete = Math.round((quota.made / quota.target) * 100);

        let statusClass = 'slds-progress-bar__value_success';
        let statusText = 'On Track';
        let statusColor = '#04844b';

        if (quota.status === 'behind') {
            statusClass = 'slds-theme_error';
            statusText = 'Behind Target';
            statusColor = '#c23934';
        } else if (quota.status === 'at-risk') {
            statusClass = 'slds-theme_warning';
            statusText = 'At Risk';
            statusColor = '#fe9339';
        }

        return `
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Daily Quota Progress</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                        <span class="slds-text-heading_large">${quota.made}</span>
                        <span class="slds-text-body_small slds-text-color_weak">/ ${quota.target} calls</span>
                    </div>
                    <div class="slds-progress-bar slds-progress-bar_large slds-m-bottom_small" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${percentComplete}">
                        <span class="slds-progress-bar__value ${statusClass}" style="width: ${percentComplete}%;"></span>
                    </div>
                    <div class="slds-grid slds-grid_align-spread">
                        <span class="slds-badge" style="background-color: ${statusColor}; color: white;">${statusText}</span>
                        <span class="slds-text-body_small slds-text-color_weak">${percentComplete}% complete</span>
                    </div>
                    ${quota.status === 'behind' ? `
                        <div class="slds-box slds-box_small slds-theme_shade slds-m-top_small" style="border-left: 4px solid #c23934;">
                            <p class="slds-text-body_small slds-text-color_default">
                                <strong>Action Needed:</strong> You need ${quota.target - quota.made} more calls to meet your daily quota.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    },

    renderAtRiskAgents() {
        const users = DataService.getUsers('supervisor');
        const atRiskAgents = AppState.getAtRiskAgents(users);

        if (atRiskAgents.length === 0) {
            return `
                <div class="slds-card">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Team Performance</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="slds-text-align_center slds-p-around_medium">
                            <div style="font-size: 3rem; color: #04844b; margin-bottom: 0.5rem;">✓</div>
                            <p class="slds-text-heading_small slds-m-bottom_x-small">All Agents On Track</p>
                            <p class="slds-text-body_small slds-text-color_weak">Everyone is meeting their quotas!</p>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">⚠️ Agents Needing Support</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-table_fixed-layout">
                        <thead>
                            <tr>
                                <th scope="col">Agent</th>
                                <th scope="col">Progress</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${atRiskAgents.map(agent => {
                                const quota = AppState.getQuotaStatus(agent.id);
                                const percent = Math.round((quota.made / quota.target) * 100);
                                const statusColor = quota.status === 'behind' ? '#c23934' : '#fe9339';
                                const statusText = quota.status === 'behind' ? 'Behind' : 'At Risk';

                                return `
                                    <tr>
                                        <td>${agent.name}</td>
                                        <td>
                                            <div class="slds-grid slds-grid_vertical-align-center">
                                                <span class="slds-text-body_small">${quota.made}/${quota.target}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="slds-badge" style="background-color: ${statusColor}; color: white;">
                                                ${statusText}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <button class="slds-button slds-button_neutral slds-button_stretch slds-m-top_small" onclick="alert('This would show detailed agent performance and coaching recommendations.')">
                        View Coaching Plan
                    </button>
                </div>
            </div>
        `;
    },

    renderTeamAlerts() {
        const unloggedCount = AppState.unloggedCallsCount;
        const missedCalls = 2; // Mock data
        const overdueFollowups = 1; // Mock data

        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Team Alerts</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    ${unloggedCount > 0 ? `
                        <div class="slds-scoped-notification slds-media slds-media_center slds-m-bottom_x-small" role="status" style="background-color: #fef7e5; border-left: 3px solid #fe9339;">
                            <div class="slds-media__body">
                                <p class="slds-text-body_small" style="color: #080707;">
                                    <strong>${unloggedCount} Unlogged Call${unloggedCount > 1 ? 's' : ''}</strong>
                                </p>
                            </div>
                        </div>
                    ` : ''}
                    ${missedCalls > 0 ? `
                        <div class="slds-scoped-notification slds-media slds-media_center slds-m-bottom_x-small" role="status" style="background-color: #feded8; border-left: 3px solid #c23934;">
                            <div class="slds-media__body">
                                <p class="slds-text-body_small" style="color: #080707;">
                                    <strong>${missedCalls} Missed Callback${missedCalls > 1 ? 's' : ''}</strong>
                                </p>
                            </div>
                        </div>
                    ` : ''}
                    ${overdueFollowups > 0 ? `
                        <div class="slds-scoped-notification slds-media slds-media_center slds-m-bottom_x-small" role="status" style="background-color: #d8edff; border-left: 3px solid #0176d3;">
                            <div class="slds-media__body">
                                <p class="slds-text-body_small" style="color: #080707;">
                                    <strong>${overdueFollowups} Overdue Follow-up${overdueFollowups > 1 ? 's' : ''}</strong>
                                </p>
                            </div>
                        </div>
                    ` : ''}
                    ${unloggedCount === 0 && missedCalls === 0 && overdueFollowups === 0 ? `
                        <p class="slds-text-body_small slds-text-color_weak slds-text-align_center">
                            All clear! No alerts at this time.
                        </p>
                    ` : `
                        <button class="slds-button slds-button_neutral slds-button_stretch slds-m-top_x-small" onclick="alert('This would show all team alerts and allow bulk actions.')">
                            View All Alerts
                        </button>
                    `}
                </div>
            </div>
        `;
    },

    renderCoachingOpportunities() {
        const atRiskAgents = AppState.getAtRiskAgents(DataService.getUsers('supervisor'));

        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Coaching Opportunities</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    ${atRiskAgents.length > 0 ? atRiskAgents.slice(0, 2).map(agent => {
                        const quota = AppState.getQuotaStatus(agent.id);
                        const percentComplete = Math.round((quota.made / quota.target) * 100);
                        const reason = percentComplete < 50 ? 'Below quota for 3 days' : 'Below target pace';

                        return `
                            <div class="slds-m-bottom_medium">
                                <div class="slds-grid slds-grid_vertical-align-start slds-m-bottom_xxx-small">
                                    <div class="slds-col slds-has-flexi-truncate">
                                        <p class="slds-text-body_small slds-text-title">${agent.name}</p>
                                    </div>
                                </div>
                                <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">
                                    ${reason}
                                </p>
                                <div class="slds-grid slds-gutters_xx-small">
                                    <div class="slds-col">
                                        <button class="slds-button slds-button_neutral slds-button_stretch" onclick="alert('This would open a messaging interface to send a message to ${agent.name}.')">
                                            Send Message
                                        </button>
                                    </div>
                                    <div class="slds-col">
                                        <button class="slds-button slds-button_neutral slds-button_stretch" onclick="alert('This would open a scheduling interface for a 1:1 with ${agent.name}.')">
                                            Schedule 1:1
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <p class="slds-text-body_small slds-text-color_weak slds-text-align_center">
                            Great job! All agents are on track.
                        </p>
                    `}
                </div>
            </div>
        `;
    },

    renderTodaysTasks() {
        const tasks = [
            { contact: 'John Smith', type: 'Follow-up', time: '10:00 AM' },
            { contact: 'Sarah Johnson', type: 'Demo Call', time: '2:30 PM' },
            { contact: 'Mike Chen', type: 'Callback', time: '4:00 PM' }
        ];

        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Today's Tasks</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    ${tasks.map((task, index) => `
                        <div class="slds-p-around_x-small ${index < tasks.length - 1 ? 'slds-border_bottom' : ''}">
                            <div class="slds-grid slds-grid_vertical-align-start slds-m-bottom_xxx-small">
                                <div class="slds-col slds-has-flexi-truncate">
                                    <p class="slds-text-body_small slds-text-title">${task.contact}</p>
                                </div>
                                <div class="slds-col slds-no-flex">
                                    <p class="slds-text-body_small slds-text-color_weak">${task.time}</p>
                                </div>
                            </div>
                            <p class="slds-text-body_small slds-text-color_weak">${task.type}</p>
                        </div>
                    `).join('')}
                    <button class="slds-button slds-button_neutral slds-button_stretch slds-m-top_x-small" onclick="alert('This would show all tasks for today.')">
                        View All Tasks
                    </button>
                </div>
            </div>
        `;
    },

    renderQuickActions() {
        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Quick Actions</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-grid slds-grid_vertical">
                        <button class="slds-button slds-button_neutral slds-button_stretch slds-m-bottom_xx-small" onclick="alert('This would open the dialer to start a new call.')">
                            Start New Call
                        </button>
                        <button class="slds-button slds-button_neutral slds-button_stretch slds-m-bottom_xx-small" onclick="alert('This would show recent voicemails.')">
                            Check Voicemail
                        </button>
                        <button class="slds-button slds-button_neutral slds-button_stretch" onclick="alert('This would open the SMS interface.')">
                            Send SMS
                        </button>
                    </div>
                </div>
            </div>
        `;
    },

    renderCallTypeBreakdown(metrics) {
        // Safety check for callTypeBreakdown
        if (!metrics || !metrics.callTypeBreakdown) {
            return `
                <div class="slds-card">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Call Type Breakdown</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <p class="slds-text-align_center slds-text-color_weak slds-p-around_medium">No data available</p>
                    </div>
                </div>
            `;
        }

        const inbound = metrics.callTypeBreakdown.inbound || 0;
        const outbound = metrics.callTypeBreakdown.outbound || 0;
        const total = inbound + outbound;
        const inboundPercent = total > 0 ? Math.round((inbound / total) * 100) : 0;
        const outboundPercent = total > 0 ? Math.round((outbound / total) * 100) : 0;

        return `
            <div class="slds-card clickable-card" style="height: 100%; display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s ease;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Call Type Breakdown</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="chart-placeholder" style="flex: 1;">
                        <p class="slds-text-color_weak">Chart shows up here</p>
                    </div>
                    <div class="slds-m-top_medium">
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_x-small">
                            <span style="width: 12px; height: 12px; background-color: #3A49DA; display: inline-block; border-radius: 2px; margin-right: 0.5rem;"></span>
                            <span class="slds-text-body_small">Inbound: ${inboundPercent}% (${inbound})</span>
                        </div>
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <span style="width: 12px; height: 12px; background-color: #06A59A; display: inline-block; border-radius: 2px; margin-right: 0.5rem;"></span>
                            <span class="slds-text-body_small">Outbound: ${outboundPercent}% (${outbound})</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderWorkTimeToday(workTime) {
        const formatTime = (minutes) => {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        };

        // Safety check for workTime
        if (!workTime) {
            return `
                <div class="slds-card">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Work Time Today</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <p class="slds-text-align_center slds-text-color_weak slds-p-around_medium">No data available</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-card clickable-card" style="height: 100%; display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s ease;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Work Time Today</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner" style="flex: 1;">
                    <div class="slds-grid slds-grid_vertical slds-gutters_x-small">
                        <div class="slds-col slds-p-around_x-small" style="border-bottom: 1px solid #dddbda;">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-body_small slds-text-color_weak">Talk Time:</span>
                                <span class="slds-text-body_small">${formatTime(workTime.talkTime || 0)}</span>
                            </div>
                        </div>
                        <div class="slds-col slds-p-around_x-small" style="border-bottom: 1px solid #dddbda;">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-body_small slds-text-color_weak">Wrap-up:</span>
                                <span class="slds-text-body_small">${formatTime(workTime.wrapUpTime || 0)}</span>
                            </div>
                        </div>
                        <div class="slds-col slds-p-around_x-small" style="border-bottom: 1px solid #dddbda;">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-body_small slds-text-color_weak">Ready:</span>
                                <span class="slds-text-body_small">${formatTime(workTime.readyTime || 0)}</span>
                            </div>
                        </div>
                        <div class="slds-col slds-p-around_x-small" style="border-bottom: 1px solid #dddbda;">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-body_small slds-text-color_weak">Hold:</span>
                                <span class="slds-text-body_small">${formatTime(workTime.holdTime || 0)}</span>
                            </div>
                        </div>
                        <div class="slds-col slds-p-around_x-small slds-m-top_x-small">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-body_small"><strong>Total:</strong></span>
                                <span class="slds-text-body_small"><strong>${formatTime(workTime.total || 0)}</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderPowerdialerListsEnhanced() {
        const lists = DataService.getLists('agent');

        return `
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Powerdialer Lists</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                        <thead>
                            <tr>
                                <th scope="col">List Name</th>
                                <th scope="col">Total</th>
                                <th scope="col">Called</th>
                                <th scope="col">Remaining</th>
                                <th scope="col">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lists.map(list => {
                                const contacted = list.completedContacts || list.contacted || 0;
                                const percent = Math.round((contacted / list.totalContacts) * 100);
                                return `
                                    <tr style="cursor: pointer; transition: background-color 0.2s ease;" onclick="window.location.hash='#/powerdialer'" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor=''">
                                        <td><span class="slds-text-link" style="pointer-events: none;">${list.name}</span></td>
                                        <td>${list.totalContacts}</td>
                                        <td>${contacted}</td>
                                        <td>${list.totalContacts - contacted}</td>
                                        <td>
                                            <div class="slds-grid slds-grid_vertical-align-center">
                                                <span class="slds-m-right_x-small">${percent}%</span>
                                                <div class="slds-progress-bar slds-progress-bar_x-small" style="width: 60px;">
                                                    <span class="slds-progress-bar__value" style="width: ${percent}%;"></span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderPowerdialerQueue() {
        const queue = DataService.getPowerdialerQueue();

        return `
            <div class="slds-card" style="height: 100%; display: flex; flex-direction: column;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Power Dialer Queue</h2>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <button class="slds-button slds-button_neutral" onclick="window.location.hash='#/powerdialer'">
                            All Records
                        </button>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner" style="flex: 1; display: flex; flex-direction: column;">
                    <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">Next contacts to call:</p>
                    <div style="flex: 1; overflow-y: auto;">
                        ${queue.map((contact, index) => `
                            <div class="slds-box slds-box_x-small slds-m-bottom_x-small" style="border-left: 3px solid ${contact.priority === 'High' ? '#c23934' : '#0176d3'}; cursor: pointer; transition: all 0.2s ease;" onclick="window.location.hash='#/contacts'" onmouseenter="this.style.backgroundColor='#f9f9f9'; this.style.transform='translateX(4px)'" onmouseleave="this.style.backgroundColor=''; this.style.transform='translateX(0)'">
                                <div class="slds-grid slds-grid_vertical-align-start">
                                    <div class="slds-col slds-has-flexi-truncate">
                                        <p class="slds-text-body_small"><strong>${index + 1}. ${contact.name}</strong></p>
                                        <p class="slds-text-body_small slds-text-color_weak">${contact.company} • ${contact.phone}</p>
                                        <p class="slds-text-body_small slds-text-color_weak slds-m-top_xxx-small">Last activity: ${contact.lastActivity}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="slds-button slds-button_brand slds-button_stretch slds-m-top_small" onclick="alert('This would start the powerdialer calling sequence.')">
                        Start Calling
                    </button>
                </div>
            </div>
        `;
    },

    renderRecentCallsAgent() {
        const calls = DataService.getCalls('agent').slice(0, 5);

        return `
            <div class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Recent Calls</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-table_fixed-layout">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 20%;">Time</th>
                                <th scope="col" style="width: 25%;">Contact</th>
                                <th scope="col" style="width: 20%;">Direction</th>
                                <th scope="col" style="width: 15%;">Duration</th>
                                <th scope="col" style="width: 20%;">Outcome</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calls.map(call => `
                                <tr style="cursor: pointer; transition: background-color 0.2s ease;" onclick="window.location.hash='#/calls'" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor=''">
                                    <td><span class="slds-text-body_small">${DataService.formatTimestamp(call.timestamp).split(', ')[1]}</span></td>
                                    <td><span class="slds-truncate" title="${call.contact}">${call.contact}</span></td>
                                    <td><span class="slds-text-body_small">${call.direction}</span></td>
                                    <td><span class="slds-text-body_small">${DataService.formatDuration(call.duration)}</span></td>
                                    <td><span class="slds-badge ${call.status === 'Completed' ? 'slds-theme_success' : 'slds-theme_warning'}">${call.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="slds-m-top_small slds-text-align_center">
                        <a href="#" class="slds-text-link" onclick="window.location.hash = '#/calls'; return false;">View All Calls</a>
                    </div>
                </div>
            </div>
        `;
    },

    renderUnloggedCallsStandalone() {
        const unloggedCount = AppState.unloggedCallsCount;
        const unloggedCalls = DataService.getUnloggedCalls(unloggedCount);

        if (unloggedCount === 0) {
            return `
                <div class="slds-card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Unlogged Calls</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <div class="slds-text-align_center slds-p-around_medium">
                            <div style="font-size: 2rem; color: #04844b; margin-bottom: 0.5rem;">✓</div>
                            <p class="slds-text-body_small slds-text-color_weak">All calls are logged!</p>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-card" style="height: 100%; display: flex; flex-direction: column;">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">Unlogged Calls</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="slds-scoped-notification slds-media slds-media_center slds-m-bottom_small" role="alert" style="background-color: #fef7e5; border-left: 3px solid #fe9339;">
                        <div class="slds-media__body">
                            <p class="slds-text-body_small" style="color: #080707;">
                                <strong>⚠️ ${unloggedCount} call${unloggedCount > 1 ? 's' : ''} need${unloggedCount === 1 ? 's' : ''} to be logged</strong>
                            </p>
                        </div>
                    </div>
                    <div style="flex: 1; overflow-y: auto;">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                            <tbody>
                                ${unloggedCalls.map(call => {
                                    const timestamp = DataService.formatTimestamp(call.timestamp);
                                    const timeOnly = timestamp.includes(',') ? timestamp.split(', ')[1] : timestamp;
                                    const duration = DataService.formatDuration(call.duration);
                                    const contactName = call.contact || 'Unknown';
                                    return `
                                    <tr>
                                        <td style="width: 80%;">
                                            <span class="slds-text-body_small">${contactName} • ${timeOnly} • ${duration}</span>
                                        </td>
                                        <td style="width: 20%; text-align: right;">
                                            <button class="slds-button slds-button_neutral slds-button_small" onclick="alert('Log call')">
                                                Log Call
                                            </button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button class="slds-button slds-button_brand slds-button_stretch slds-m-top_small" onclick="alert('This would log all unlogged calls with default disposition.')">
                        Log All Calls
                    </button>
                </div>
            </div>
        `;
    },

    renderOpenCasesWidget() {
        const userId = window.RoleManager?.currentUserId || '005xx000001X8Uz';
        const cases = DataService.getCases(userId, 'open');
        const caseCounts = DataService.getCaseCountsByStatus(userId);

        // Helper function for priority badge styling
        const getPriorityClass = (priority) => {
            const priorityMap = {
                'High': 'slds-badge slds-theme_error',
                'Medium': 'slds-badge slds-theme_warning',
                'Low': 'slds-badge'
            };
            return priorityMap[priority] || 'slds-badge';
        };

        // Helper function for status badge styling
        const getStatusClass = (status) => {
            const statusMap = {
                'New': 'slds-badge',
                'In Progress': 'slds-badge slds-theme_info',
                'Escalated': 'slds-badge slds-theme_warning'
            };
            return statusMap[status] || 'slds-badge';
        };

        // Format timestamp to relative time
        const getRelativeTime = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        };

        if (cases.length === 0) {
            return `
                <div class="slds-card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">My Open Cases</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <div class="slds-text-align_center slds-p-around_medium">
                            <div style="font-size: 2rem; color: #04844b; margin-bottom: 0.5rem;">✓</div>
                            <p class="slds-text-body_small slds-text-color_weak">No open cases</p>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="slds-card" style="height: 100%; display: flex; flex-direction: column;">
                <div class="slds-card__header slds-grid slds-grid_align-spread">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">My Open Cases</h2>
                            <p class="slds-text-body_small slds-text-color_weak">${caseCounts.total} open • ${caseCounts.new} new • ${caseCounts.escalated} escalated</p>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <button class="slds-button slds-button_neutral" onclick="alert('View all cases')">
                            View All
                        </button>
                    </div>
                </div>
                <div class="slds-card__body" style="padding: 0; flex: 1; overflow-y: auto; max-height: 400px;">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_fixed-layout">
                        <thead>
                            <tr class="slds-line-height_reset">
                                <th scope="col" style="width: 12%;">
                                    <div class="slds-truncate" title="Case #">Case #</div>
                                </th>
                                <th scope="col" style="width: 35%;">
                                    <div class="slds-truncate" title="Subject">Subject</div>
                                </th>
                                <th scope="col" style="width: 20%;">
                                    <div class="slds-truncate" title="Account">Account</div>
                                </th>
                                <th scope="col" style="width: 12%;">
                                    <div class="slds-truncate" title="Priority">Priority</div>
                                </th>
                                <th scope="col" style="width: 13%;">
                                    <div class="slds-truncate" title="Status">Status</div>
                                </th>
                                <th scope="col" style="width: 8%;">
                                    <div class="slds-truncate" title="Age">Age</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cases.map(caseItem => `
                                <tr class="slds-hint-parent" style="cursor: pointer; transition: background-color 0.2s ease;" onclick="alert('View case ${caseItem.caseNumber}')" onmouseenter="this.style.backgroundColor='#f9f9f9'" onmouseleave="this.style.backgroundColor=''">
                                    <td data-label="Case #" style="padding: 0.5rem 0.75rem;">
                                        <a href="#" onclick="event.stopPropagation(); alert('View case ${caseItem.caseNumber}'); return false;" class="slds-text-link">${caseItem.caseNumber}</a>
                                    </td>
                                    <td data-label="Subject" class="slds-cell-wrap" style="padding: 0.5rem 0.75rem;">
                                        <span class="slds-text-body_small" style="font-weight: 600;">${caseItem.subject}</span>
                                    </td>
                                    <td data-label="Account" class="slds-cell-wrap" style="padding: 0.5rem 0.75rem;">
                                        <span class="slds-text-body_small">${caseItem.accountName}</span>
                                    </td>
                                    <td data-label="Priority" style="padding: 0.5rem 0.75rem;">
                                        <span class="${getPriorityClass(caseItem.priority)}">${caseItem.priority}</span>
                                    </td>
                                    <td data-label="Status" style="padding: 0.5rem 0.75rem;">
                                        <span class="${getStatusClass(caseItem.status)}">${caseItem.status}</span>
                                    </td>
                                    <td data-label="Age" style="padding: 0.5rem 0.75rem;">
                                        <span class="slds-text-body_small slds-text-color_weak">${getRelativeTime(caseItem.createdDate)}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderAICsatChart() {
        const csatData = DataService.getAICsatTrend();

        return `
            <div class="slds-card clickable-card" style="height: 100%; display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s ease;" onclick="window.location.hash='#/reports'" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">AI CSAT</h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="slds-text-align_center slds-m-bottom_medium">
                        <div style="font-size: 3rem; font-weight: 700; color: #3A49DA; line-height: 1;">★ ${csatData.average}</div>
                        <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">Average score</p>
                        <p class="slds-text-body_small slds-text-color_weak">${csatData.totalResponses} responses</p>
                    </div>
                    <div class="chart-placeholder" style="flex: 1;">
                        <p class="slds-text-color_weak">Chart shows up here</p>
                    </div>
                </div>
            </div>
        `;
    },

    renderComingSoonPage(title, description) {
        return `
            <div class="slds-container_fluid slds-p-around_large">
                <div style="max-width: 800px; margin: 0 auto; text-align: center; padding-top: 4rem;">
                    <div class="slds-illustration slds-illustration_large">
                        <svg class="slds-illustration__svg" viewBox="0 0 454 300" style="width: 300px; height: 200px; margin: 0 auto;">
                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <g transform="translate(-67.000000, -100.000000)">
                                    <g>
                                        <g transform="translate(125.000000, 200.000000)">
                                            <circle fill="#E0E5EE" cx="169" cy="100" r="100"></circle>
                                            <path d="M169,50 L169,150 M119,100 L219,100" stroke="#0176D3" stroke-width="8" stroke-linecap="round"></path>
                                        </g>
                                    </g>
                                </g>
                            </g>
                        </svg>
                    </div>
                    <div class="slds-m-top_large">
                        <h1 class="slds-text-heading_large slds-m-bottom_medium">${title}</h1>
                        <p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_large" style="font-size: 1.125rem;">
                            ${description}
                        </p>
                        <div class="slds-box slds-theme_shade slds-p-around_medium" style="max-width: 600px; margin: 0 auto;">
                            <p class="slds-text-body_small slds-text-color_weak">
                                <strong>Coming Soon</strong><br>
                                This feature is currently under development. Check back soon for updates.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderLiveSentimentMonitor() {
        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                Live Sentiment Monitor
                            </h2>
                        </div>
                        <div class="slds-no-flex">
                            <span class="slds-badge" style="background-color: #c23934; color: white;">2 At-Risk</span>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">
                        Active calls with negative sentiment
                    </p>

                    <div class="slds-box slds-box_x-small slds-m-bottom_small" style="background-color: #feded8; border-left: 3px solid #c23934;">
                        <div class="slds-grid slds-grid_vertical-align-start">
                            <div class="slds-col slds-has-flexi-truncate">
                                <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">
                                    <span style="color: #c23934; font-weight: 600;">😞 Negative</span> • Mike Chen
                                </p>
                                <p class="slds-text-body_small slds-m-bottom_xxx-small">
                                    Call with ABC Corp - 12 min
                                </p>
                                <p class="slds-text-body_small slds-text-color_weak">
                                    AI detected: pricing objection, competitor mention
                                </p>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters_xx-small slds-m-top_x-small">
                            <div class="slds-col">
                                <button class="slds-button slds-button_neutral slds-button_stretch" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                    View Live Transcript
                                </button>
                            </div>
                            <div class="slds-col">
                                <button class="slds-button slds-button_brand slds-button_stretch" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                    Join Call
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="slds-box slds-box_x-small" style="background-color: #feded8; border-left: 3px solid #c23934;">
                        <div class="slds-grid slds-grid_vertical-align-start">
                            <div class="slds-col slds-has-flexi-truncate">
                                <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">
                                    <span style="color: #c23934; font-weight: 600;">😞 Negative</span> • Sarah Johnson
                                </p>
                                <p class="slds-text-body_small slds-m-bottom_xxx-small">
                                    Call with XYZ Inc - 8 min
                                </p>
                                <p class="slds-text-body_small slds-text-color_weak">
                                    AI detected: billing dispute, escalation request
                                </p>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters_xx-small slds-m-top_x-small">
                            <div class="slds-col">
                                <button class="slds-button slds-button_neutral slds-button_stretch" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                    View Live Transcript
                                </button>
                            </div>
                            <div class="slds-col">
                                <button class="slds-button slds-button_brand slds-button_stretch" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                    Join Call
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="slds-text-align_center slds-m-top_small">
                        <a href="#" class="slds-text-link">View All Active Calls (12)</a>
                    </div>
                </div>
            </div>
        `;
    },

    renderAiPlaybookAdherence() {
        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                AI Playbook Adherence
                            </h2>
                        </div>
                        <div class="slds-no-flex">
                            <span class="slds-badge slds-theme_warning">78%</span>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">
                        BANT Methodology - Last 7 Days
                    </p>

                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_xxx-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <p class="slds-text-body_small">Budget Discussed</p>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <span class="slds-badge" style="background-color: #4bca81; color: white;">85%</span>
                            </div>
                        </div>
                        <div class="slds-progress-bar" style="height: 6px;">
                            <span class="slds-progress-bar__value" style="width: 85%; background-color: #4bca81;"></span>
                        </div>
                    </div>

                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_xxx-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <p class="slds-text-body_small">Authority Confirmed</p>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <span class="slds-badge" style="background-color: #ffb75d; color: white;">72%</span>
                            </div>
                        </div>
                        <div class="slds-progress-bar" style="height: 6px;">
                            <span class="slds-progress-bar__value" style="width: 72%; background-color: #ffb75d;"></span>
                        </div>
                    </div>

                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_xxx-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <p class="slds-text-body_small">Need Identified</p>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <span class="slds-badge" style="background-color: #4bca81; color: white;">91%</span>
                            </div>
                        </div>
                        <div class="slds-progress-bar" style="height: 6px;">
                            <span class="slds-progress-bar__value" style="width: 91%; background-color: #4bca81;"></span>
                        </div>
                    </div>

                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_xxx-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <p class="slds-text-body_small">Timing Captured</p>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <span class="slds-badge" style="background-color: #c23934; color: white;">64%</span>
                            </div>
                        </div>
                        <div class="slds-progress-bar" style="height: 6px;">
                            <span class="slds-progress-bar__value" style="width: 64%; background-color: #c23934;"></span>
                        </div>
                    </div>

                    <div class="slds-text-align_center slds-m-top_small">
                        <a href="#" class="slds-text-link">View Agent Breakdown</a>
                    </div>
                </div>
            </div>
        `;
    },

    renderAgentAiActionItems() {
        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                <span class="slds-icon_container slds-icon-utility-checklist" style="margin-right: 0.5rem;">
                                    <svg class="slds-icon slds-icon_x-small" aria-hidden="true" style="width: 16px; height: 16px; fill: #3A49DA;">
                                        <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#checklist")}"></use>
                                    </svg>
                                </span>
                                AI Action Items
                            </h2>
                        </div>
                        <div class="slds-no-flex">
                            <span class="slds-badge slds-theme_warning">3 Pending</span>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-start slds-m-bottom_x-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <div class="slds-form-element">
                                    <div class="slds-form-element__control">
                                        <div class="slds-checkbox">
                                            <input type="checkbox" id="action-1" />
                                            <label class="slds-checkbox__label" for="action-1">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label slds-text-body_small">Send pricing quote to Acme Corp</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="slds-text-body_small slds-text-color_weak" style="margin-left: 1.5rem;">
                            <span style="color: #c23934; font-weight: 600;">Due: Today 5pm</span> • From call at 2:15pm
                        </p>
                    </div>

                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-start slds-m-bottom_x-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <div class="slds-form-element">
                                    <div class="slds-form-element__control">
                                        <div class="slds-checkbox">
                                            <input type="checkbox" id="action-2" />
                                            <label class="slds-checkbox__label" for="action-2">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label slds-text-body_small">Schedule demo for Tech Solutions Inc</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="slds-text-body_small slds-text-color_weak" style="margin-left: 1.5rem;">
                            <span style="color: #ffb75d; font-weight: 600;">Due: Tomorrow</span> • From call at 11:30am
                        </p>
                    </div>

                    <div class="slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-start slds-m-bottom_x-small">
                            <div class="slds-col slds-has-flexi-truncate">
                                <div class="slds-form-element">
                                    <div class="slds-form-element__control">
                                        <div class="slds-checkbox">
                                            <input type="checkbox" id="action-3" />
                                            <label class="slds-checkbox__label" for="action-3">
                                                <span class="slds-checkbox_faux"></span>
                                                <span class="slds-form-element__label slds-text-body_small">Send case study to Global Industries</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="slds-text-body_small slds-text-color_weak" style="margin-left: 1.5rem;">
                            <span style="color: #4bca81; font-weight: 600;">Due: Friday</span> • From call yesterday
                        </p>
                    </div>

                    <div class="slds-text-align_center slds-m-top_small">
                        <a href="#" class="slds-text-link">View All Action Items (5)</a>
                    </div>
                </div>
            </div>
        `;
    },

    renderAgentAiRecaps() {
        return `
            <div class="slds-card slds-m-top_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                <span class="slds-icon_container" style="margin-right: 0.5rem;">
                                    <svg class="slds-icon slds-icon_x-small" aria-hidden="true" style="width: 16px; height: 16px; fill: #3A49DA;">
                                        <use xlink:href="${getAssetPath("assets/icons/utility-sprite/svg/symbols.svg#bundle_config")}"></use>
                                    </svg>
                                </span>
                                Recent AI Recaps
                            </h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-box slds-box_x-small slds-theme_shade slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-start">
                            <div class="slds-col">
                                <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">
                                    <span class="slds-badge" style="background-color: #4bca81; color: white; margin-right: 0.25rem;">92% 😊</span>
                                    John Smith - 3:45pm
                                </p>
                                <p class="slds-text-body_small slds-m-bottom_xxx-small">
                                    Customer inquired about Enterprise pricing. Provided quote and discussed volume discounts. Follow-up scheduled.
                                </p>
                                <p class="slds-text-body_small slds-text-color_weak">
                                    <strong>Outcome:</strong> Quote Sent • <strong>Duration:</strong> 8 min
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="slds-box slds-box_x-small slds-theme_shade slds-m-bottom_small">
                        <div class="slds-grid slds-grid_vertical-align-start">
                            <div class="slds-col">
                                <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">
                                    <span class="slds-badge" style="background-color: #ffb75d; color: white; margin-right: 0.25rem;">78% 😐</span>
                                    Sarah Johnson - 2:15pm
                                </p>
                                <p class="slds-text-body_small slds-m-bottom_xxx-small">
                                    Support call regarding billing issue. Resolved duplicate charge, applied $50 credit to account.
                                </p>
                                <p class="slds-text-body_small slds-text-color_weak">
                                    <strong>Outcome:</strong> Issue Resolved • <strong>Duration:</strong> 12 min
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="slds-box slds-box_x-small slds-theme_shade">
                        <div class="slds-grid slds-grid_vertical-align-start">
                            <div class="slds-col">
                                <p class="slds-text-body_small slds-text-title slds-m-bottom_xxx-small">
                                    <span class="slds-badge" style="background-color: #4bca81; color: white; margin-right: 0.25rem;">95% 😊</span>
                                    Mike Chen - 11:30am
                                </p>
                                <p class="slds-text-body_small slds-m-bottom_xxx-small">
                                    Product demo completed successfully. Customer very interested in integration features. Next step: technical call with engineering.
                                </p>
                                <p class="slds-text-body_small slds-text-color_weak">
                                    <strong>Outcome:</strong> Demo Completed • <strong>Duration:</strong> 45 min
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="slds-text-align_center slds-m-top_small">
                        <a href="#" class="slds-text-link">View All Recaps</a>
                    </div>
                </div>
            </div>
        `;
    },

    updateTabVisibility() {
        const currentRole = RoleManager.getRole();

        // Show/hide tabs based on role visibility
        document.querySelectorAll('.slds-context-bar__item[data-role-visibility]').forEach(tabItem => {
            const visibleRoles = tabItem.getAttribute('data-role-visibility').split(',');
            if (visibleRoles.includes(currentRole)) {
                tabItem.style.display = '';
            } else {
                tabItem.style.display = 'none';
            }
        });
    },

    // Powerdialer Session Action Handlers
    startCalling(listId) {
        AppState.startDialerSession(listId);
        this.renderCurrentPage();
    },

    callNow() {
        const session = AppState.getDialerSession();
        const queue = DataService.getPowerdialerQueue(null, 100);
        const currentContact = queue[session.contactIndex];

        if (currentContact) {
            // Show toast/alert simulating call
            alert(`Call initiated to ${currentContact.name} at ${currentContact.phone}`);

            // Advance to next contact
            AppState.advanceToNextContact();

            // Check if we've reached the end of the queue
            if (session.contactIndex >= queue.length - 1) {
                alert('You have reached the end of the queue. Session will end.');
                AppState.endDialerSession();
            }
        }

        this.renderCurrentPage();
    },

    skipContact() {
        const session = AppState.getDialerSession();
        const queue = DataService.getPowerdialerQueue(null, 100);
        const currentContact = queue[session.contactIndex];

        if (currentContact) {
            AppState.skipCurrentContact(currentContact.id);

            // Check if we've reached the end of the queue
            if (session.contactIndex >= queue.length - 1) {
                alert('You have reached the end of the queue. Session will end.');
                AppState.endDialerSession();
            }
        }

        this.renderCurrentPage();
    },

    pauseSession() {
        AppState.pauseDialerSession();
        this.renderCurrentPage();
    },

    resumeSession() {
        AppState.resumeDialerSession();
        this.renderCurrentPage();
    },

    endSession() {
        if (confirm('Are you sure you want to end this powerdialer session?')) {
            AppState.endDialerSession();
            this.renderCurrentPage();
        }
    }
};

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    App.init();
    // Expose app instance globally for sidebar navigation
    window.app = App;
    window.DialpadApp = App; // Alias for onclick handlers
});
